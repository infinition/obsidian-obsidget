{
    "id": "photo-gallery",
    "name": "Photo Gallery",
    "description": "A high-performance 2D photo gallery accelerated by GPU. Features smooth inertia scrolling, justified/square layouts, dynamic search, and an advanced interactive lightbox.",
    "author": "Infinition",
    "authorUrl": "https://github.com/infinition",
    "data": {
        "settings": {
            "folders": [],
            "includeAll": true,
            "sortBy": "mtime-desc",
            "zoom": 200,
            "layout": "justified",
            "height": 600,
            "search": "",
            "showNames": false
        }
    },
    "html": "<div class=\"gallery-container\" id=\"gallery-root\">\n  <div class=\"gallery-header\">\n    <div class=\"header-main\">\n      <div class=\"layout-toggle-mini\">\n        <button id=\"btn-layout-square\" title=\"Square Grid\">\n          <svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><rect x=\"3\" y=\"3\" width=\"7\" height=\"7\"></rect><rect x=\"14\" y=\"3\" width=\"7\" height=\"7\"></rect><rect x=\"3\" y=\"14\" width=\"7\" height=\"7\"></rect><rect x=\"14\" y=\"14\" width=\"7\" height=\"7\"></rect></svg>\n        </button>\n        <button id=\"btn-layout-justified\" title=\"Justified Layout\">\n          <svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"7\"></rect><rect x=\"3\" y=\"14\" width=\"10\" height=\"7\"></rect><rect x=\"15\" y=\"14\" width=\"6\" height=\"7\"></rect></svg>\n        </button>\n      </div>\n      \n      <div class=\"search-wrapper\">\n        <svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><circle cx=\"11\" cy=\"11\" r=\"8\"></circle><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"></line></svg>\n        <input type=\"text\" id=\"gal-search\" placeholder=\"Search...\" autocomplete=\"off\">\n        <button id=\"btn-clear-search\" class=\"clear-btn\">\n          <svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line><line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line></svg>\n        </button>\n      </div>\n    </div>\n\n    <div class=\"header-controls\">\n      <div class=\"control-group\">\n        <div class=\"select-wrapper\" title=\"Sort By\">\n           <svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"></line><polyline points=\"19 12 12 19 5 12\"></polyline></svg>\n           <select id=\"opt-sort-by\">\n            <option value=\"mtime-desc\">Date (Newest)</option>\n            <option value=\"mtime-asc\">Date (Oldest)</option>\n            <option value=\"ctime-desc\">Created (Newest)</option>\n            <option value=\"name-asc\">Name (A-Z)</option>\n            <option value=\"size-desc\">Size (Largest)</option>\n          </select>\n        </div>\n\n        <div class=\"folder-wrapper\">\n          <button id=\"btn-folders\" class=\"icon-btn\" title=\"Filter Folders\">\n            <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"></path></svg>\n          </button>\n          <div id=\"folder-popup\" class=\"folder-popup\">\n             <div class=\"popup-header\">\n               <input type=\"text\" id=\"folder-search\" placeholder=\"Filter folders...\" class=\"folder-search-input\">\n               <label class=\"checkbox-label\">\n                 <input type=\"checkbox\" id=\"opt-include-all\"> All Vault\n               </label>\n             </div>\n             <div id=\"folder-list\" class=\"folder-list\"></div>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"separator\"></div>\n\n      <button id=\"btn-toggle-names\" class=\"icon-btn\" title=\"Toggle Filenames\">\n        <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M4 7V4h16v3M9 20h6M12 4v16\"></path></svg>\n      </button>\n      \n      <button id=\"btn-edit-mode\" class=\"icon-btn\" title=\"Edit Mode\">\n        <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"></path><path d=\"M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z\"></path></svg>\n      </button>\n\n      <div class=\"zoom-controls\">\n        <button id=\"btn-zoom-out\">‚àí</button>\n        <input type=\"range\" id=\"zoom-slider\" min=\"50\" max=\"1000\" step=\"1\">\n        <button id=\"btn-zoom-in\">+</button>\n      </div>\n      \n      <button class=\"icon-btn\" id=\"btn-help\" title=\"Help & Shortcuts\">\n        <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><line x1=\"12\" y1=\"16\" x2=\"12\" y2=\"12\"></line><line x1=\"12\" y1=\"8\" x2=\"12.01\" y2=\"8\"></line></svg>\n      </button>\n\n      <button class=\"icon-btn\" id=\"btn-fullscreen\" title=\"Toggle Fullscreen\">\n        <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3\"></path></svg>\n      </button>\n    </div>\n  </div>\n\n  <div class=\"edit-toolbar\" id=\"edit-toolbar\">\n    <div class=\"selection-info\"><span id=\"selection-count\">0</span> selected</div>\n    <div class=\"toolbar-actions\">\n      <button id=\"btn-add-to-note\" class=\"action-btn\">\n        <svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\"></path><polyline points=\"14 2 14 8 20 8\"></polyline><line x1=\"12\" y1=\"18\" x2=\"12\" y2=\"12\"></line><line x1=\"9\" y1=\"15\" x2=\"15\" y2=\"15\"></line></svg>\n        Add to Note\n      </button>\n      <button id=\"btn-copy-selection\" class=\"action-btn\">\n        <svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" ry=\"2\"></rect><path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\"></path></svg>\n        Copy Links\n      </button>\n      <button id=\"btn-delete-selection\" class=\"action-btn danger\">\n        <svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polyline points=\"3 6 5 6 21 6\"></polyline><path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"></path></svg>\n        Delete\n      </button>\n      <button id=\"btn-cancel-edit\" class=\"action-btn secondary\">Cancel</button>\n    </div>\n  </div>\n\n  <div class=\"gallery-main\">\n    <canvas id=\"gallery-canvas\"></canvas>\n    <div id=\"date-scrubber\" class=\"date-scrubber\">\n      <div class=\"scrubber-track\" id=\"scrubber-track\"></div>\n    </div>\n  </div>\n\n  <div id=\"lightbox\" class=\"lightbox\">\n    <button class=\"lightbox-nav prev\" id=\"btn-lb-prev\">‚ùÆ</button>\n    <div class=\"lightbox-content\" id=\"lightbox-content\">\n      <img id=\"lightbox-img\" src=\"\" draggable=\"false\">\n    </div>\n    <button class=\"lightbox-nav next\" id=\"btn-lb-next\">‚ùØ</button>\n    <div class=\"lightbox-info\">\n      <span id=\"lightbox-name\"></span>\n      <span id=\"lightbox-meta\"></span>\n      <div class=\"lightbox-actions\">\n        <button id=\"btn-lb-copy\" class=\"lb-action-btn\" title=\"Copy Markdown Link\">\n          <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" ry=\"2\"></rect><path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\"></path></svg>\n          Copy Link\n        </button>\n      </div>\n    </div>\n    <button class=\"lightbox-close\">‚úï</button>\n    <div class=\"lightbox-hint\">Scroll to zoom ‚Ä¢ Drag to pan ‚Ä¢ Swipe/Arrows to navigate</div>\n  </div>\n\n  <div class=\"modal-overlay\" id=\"note-selector-modal\">\n    <div class=\"modal-box\">\n      <div class=\"modal-header\">\n        <span>Add to Note</span>\n        <button class=\"modal-close\" id=\"btn-close-note-modal\">‚úï</button>\n      </div>\n      <div class=\"modal-body\">\n        <input type=\"text\" id=\"note-search\" placeholder=\"Search notes...\" class=\"full-width-input\">\n        <div id=\"note-list\" class=\"note-list\"></div>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"modal-overlay\" id=\"help-modal\">\n    <div class=\"modal-box help-box\">\n      <div class=\"modal-header\">\n        <span>Gallery Guide & Shortcuts</span>\n        <button class=\"modal-close\" id=\"btn-close-help\">‚úï</button>\n      </div>\n      <div class=\"modal-body help-content\">\n        <div class=\"help-section\">\n          <h4>üñ±Ô∏è Interactions</h4>\n          <ul>\n            <li><b>RIGHT Click:</b> Enlarge photo. We use right-click to avoid Obsidian's native double-click behavior, which would exit fullscreen or trigger edit mode.</li>\n            <li><b>LEFT Click:</b> Select an image (when in Edit Mode).</li>\n            <li><b>Drag:</b> Scroll the gallery or pan a zoomed photo.</li>\n            <li><b>CTRL + Wheel:</b> Smoothly zoom the gallery grid size.</li>\n          </ul>\n        </div>\n        <div class=\"help-section\">\n          <h4>üñºÔ∏è Lightbox (Viewer)</h4>\n          <ul>\n            <li><b>Arrows / Swipe:</b> Navigate between photos.</li>\n            <li><b>Wheel:</b> Zoom in/out on the current photo.</li>\n            <li><b>Escape:</b> Close the viewer.</li>\n          </ul>\n        </div>\n        <div class=\"help-section\">\n          <h4>üõ†Ô∏è Features</h4>\n          <ul>\n            <li><b>Folders:</b> Filter by folder with integrated search.</li>\n            <li><b>Sort:</b> Sort by date, name, or file size.</li>\n            <li><b>Layout:</b> Toggle Square or Justified (real size) modes, and show/hide names.</li>\n            <li><b>Edit Mode:</b> Delete selection, \"Add to Note\" (.md), or Copy markdown links.</li>\n            <li><b>Fullscreen:</b> Toggle fullscreen mode using the button in the header. Avoid double-clicking images in fullscreen as it may cause you to exit the mode.</li>\n            <li><b>Memory:</b> Widget height (resizable at bottom-right) and all settings are automatically saved.</li>\n          </ul>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>",
    "css": ":host {\n  --gal-bg: var(--background-primary);\n  --gal-header: var(--background-secondary);\n  --gal-accent: var(--interactive-accent);\n  --gal-text: var(--text-normal);\n  --gal-muted: var(--text-muted);\n  --gal-border: var(--background-modifier-border);\n  --gal-radius: 12px;\n}\n\n.gallery-container {\n  width: 100%;\n  min-height: 300px;\n  background: var(--gal-bg);\n  border-radius: var(--gal-radius);\n  border: 1px solid var(--gal-border);\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n  position: relative;\n  font-family: var(--font-interface);\n  resize: vertical;\n}\n\n.gallery-header {\n  padding: 8px 12px;\n  background: var(--gal-header);\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  border-bottom: 1px solid var(--gal-border);\n  z-index: 10;\n  gap: 15px;\n  flex-shrink: 0;\n  height: 46px;\n}\n\n.header-main {\n  flex: 1;\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  min-width: 0;\n}\n\n.layout-toggle-mini {\n  display: flex; background: var(--background-primary-alt); padding: 2px; border-radius: 6px; border: 1px solid var(--gal-border); flex-shrink: 0;\n}\n\n.layout-toggle-mini button {\n  background: none; border: none; color: var(--gal-muted); cursor: pointer; padding: 4px; border-radius: 4px; display: flex; transition: all 0.2s;\n}\n\n.layout-toggle-mini button.active { background: var(--gal-accent); color: white; }\n\n.search-wrapper {\n  background: var(--background-primary-alt); border: 1px solid var(--gal-border); border-radius: 6px; padding: 4px 10px; display: flex; align-items: center; gap: 8px; color: var(--gal-muted); transition: all 0.2s; flex: 1; max-width: 400px;\n}\n\n.search-wrapper:focus-within { border-color: var(--gal-accent); box-shadow: 0 0 0 2px rgba(var(--interactive-accent-rgb), 0.1); }\n.search-wrapper input { background: none; border: none; color: var(--gal-text); font-size: 0.85rem; width: 100%; outline: none; padding: 2px 0; }\n\n.clear-btn {\n  background: none; border: none; color: var(--gal-muted); cursor: pointer; padding: 2px; display: none; align-items: center; justify-content: center; border-radius: 50%;\n}\n.clear-btn:hover { background: var(--background-modifier-hover); color: var(--gal-text); }\n.search-wrapper input:not(:placeholder-shown) + .clear-btn { display: flex; }\n\n.header-controls {\n  display: flex; align-items: center; gap: 8px; flex-shrink: 0;\n}\n\n.control-group {\n  display: flex; align-items: center; gap: 4px;\n  background: var(--background-primary-alt);\n  padding: 3px 6px;\n  border-radius: 8px;\n  border: 1px solid var(--gal-border);\n}\n\n.select-wrapper {\n  position: relative; display: flex; align-items: center; color: var(--gal-muted);\n}\n.select-wrapper svg { position: absolute; left: 4px; pointer-events: none; }\n.select-wrapper select {\n  appearance: none; background: var(--background-primary); border: 1px solid var(--gal-border); border-radius: 4px; color: var(--gal-text); font-size: 0.8rem; padding: 2px 4px 2px 22px; cursor: pointer; outline: none; width: 120px; font-weight: 500;\n}\n.select-wrapper select option { background: var(--background-primary); color: var(--gal-text); }\n.select-wrapper select:hover { border-color: var(--gal-accent); color: var(--gal-accent); }\n\n.folder-wrapper { position: relative; }\n.folder-popup {\n  position: absolute; top: 100%; right: 0; margin-top: 8px; width: 280px; background: var(--gal-bg); border: 1px solid var(--gal-border); border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100; display: none; flex-direction: column; overflow: hidden;\n}\n.folder-popup.active { display: flex; }\n.popup-header { padding: 8px 10px; border-bottom: 1px solid var(--gal-border); background: var(--gal-header); font-size: 0.8rem; font-weight: 600; display: flex; flex-direction: column; gap: 8px; }\n.folder-search-input { width: 100%; background: var(--background-primary); border: 1px solid var(--gal-border); padding: 4px 8px; border-radius: 4px; color: var(--gal-text); font-size: 0.8rem; }\n.folder-list { max-height: 250px; overflow-y: auto; padding: 5px; }\n.folder-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; }\n.folder-item:hover { background: var(--background-modifier-hover); }\n.folder-item.selected { background: rgba(var(--interactive-accent-rgb), 0.1); color: var(--gal-accent); font-weight: 600; }\n\n.separator { width: 1px; height: 20px; background: var(--gal-border); margin: 0 4px; }\n\n.icon-btn {\n  background: none; border: none; color: var(--gal-muted); cursor: pointer; padding: 6px; border-radius: 6px; display: flex; transition: all 0.2s;\n}\n.icon-btn:hover { background: var(--background-modifier-hover); color: var(--gal-text); }\n.icon-btn.active { background: var(--gal-accent); color: white; }\n\n.zoom-controls {\n  display: flex; align-items: center; gap: 4px; background: var(--background-primary-alt); padding: 2px 8px; border-radius: 20px; border: 1px solid var(--gal-border);\n}\n.zoom-controls input { width: 50px; accent-color: var(--gal-accent); }\n.zoom-controls button { background: none; border: none; color: var(--gal-text); cursor: pointer; font-weight: bold; font-size: 0.9rem; padding: 0 4px; }\n\n.edit-toolbar {\n  position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: var(--gal-accent); color: white; padding: 8px 20px; border-radius: 30px; display: none; align-items: center; gap: 20px; z-index: 20; box-shadow: 0 10px 30px rgba(0,0,0,0.3); font-size: 0.85rem; font-weight: 600;\n}\n.edit-toolbar.active { display: flex; }\n.toolbar-actions { display: flex; gap: 10px; }\n.action-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 12px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.75rem; transition: all 0.2s; }\n.action-btn:hover { background: rgba(255,255,255,0.3); }\n.action-btn.danger:hover { background: #ff4444; }\n\n.gallery-main {\n  flex: 1; display: flex; position: relative; overflow: hidden; background: #000;\n}\n#gallery-canvas { flex: 1; width: 100%; height: 100%; cursor: grab; touch-action: none; }\n#gallery-canvas:active { cursor: grabbing; }\n\n.lightbox {\n  position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); display: none; z-index: 10000; flex-direction: column; overflow: hidden;\n}\n.lightbox-content {\n  flex: 1; display: flex; align-items: center; justify-content: center; cursor: grab; overflow: hidden; position: relative; touch-action: none;\n}\n#lightbox-img {\n  width: 100%; height: 100%; object-fit: contain; box-shadow: 0 0 50px rgba(0,0,0,0.5); transform-origin: center; transition: transform 0.1s ease-out; pointer-events: none; user-select: none; -webkit-user-select: none;\n}\n.lightbox-info {\n  padding: 20px; background: linear-gradient(transparent, rgba(0,0,0,0.8)); text-align: center; color: white; z-index: 10;\n}\n.lightbox-close {\n  position: absolute; top: 30px; right: 30px; background: rgba(0,0,0,0.5); border: none; color: white; font-size: 1.5rem; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; z-index: 100; display: flex; align-items: center; justify-content: center; transition: all 0.2s;\n}\n.lightbox-nav {\n  position: absolute; top: 50%; transform: translateY(-50%);\n  background: rgba(0,0,0,0.2); color: rgba(255,255,255,0.7); border: none;\n  font-size: 3rem; padding: 20px; cursor: pointer; z-index: 100;\n  transition: all 0.2s; border-radius: 50%; width: 60px; height: 60px;\n  display: flex; align-items: center; justify-content: center;\n}\n.lightbox-nav:hover { background: rgba(255,255,255,0.2); color: white; }\n.lightbox-nav.prev { left: 20px; }\n.lightbox-nav.next { right: 20px; }\n\n.modal-overlay {\n  position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: none; z-index: 200; justify-content: center; align-items: center;\n}\n.modal-box {\n  background: var(--gal-bg); width: 400px; max-width: 90%; border-radius: 12px; border: 1px solid var(--gal-border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); overflow: hidden; display: flex; flex-direction: column;\n}\n.modal-header {\n  padding: 12px 16px; background: var(--gal-header); display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: var(--gal-text); border-bottom: 1px solid var(--gal-border);\n}\n.modal-close { background: none; border: none; color: var(--gal-muted); cursor: pointer; font-size: 1.2rem; }\n.modal-body { padding: 16px; display: flex; flex-direction: column; gap: 12px; }\n.full-width-input { width: 100%; padding: 8px; border: 1px solid var(--gal-border); border-radius: 6px; background: var(--background-primary); color: var(--gal-text); }\n.note-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--gal-border); border-radius: 6px; display: none; }\n.note-list.active { display: block; }\n.note-item { padding: 8px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid var(--gal-border); }\n.note-item:hover { background: var(--background-modifier-hover); }\n\n.help-box { width: 450px; }\n.help-content { font-size: 0.85rem; line-height: 1.4; color: var(--gal-text); }\n.help-section h4 { margin: 12px 0 6px 0; color: var(--gal-accent); border-bottom: 1px solid var(--gal-border); padding-bottom: 4px; }\n.help-section ul { margin: 0; padding-left: 20px; }\n.help-section li { margin-bottom: 4px; }\n",
    "js": "var root = api.root;\nvar app = window.app || api.app;\nvar canvas = root.getElementById('gallery-canvas');\nvar ctx = canvas.getContext('2d', { alpha: false });\nvar state = {\n  allImages: [],\n  filteredImages: [],\n  settings: {\n    folders: [],\n    includeAll: true,\n    sortBy: 'mtime-desc',\n    zoom: 200,\n    layout: 'justified',\n    height: 600,\n    search: '',\n    showNames: false\n  },\n  scroll: 0,\n  targetScroll: 0,\n  isDragging: false,\n  isPointerDown: false,\n  startY: 0,\n  startScroll: 0,\n  hasMoved: false,\n  selection: new Set(),\n  lastMouseY: 0,\n  rowHeight: 200,\n  gap: 10,\n  cache: new Map(),\n  layoutData: [],\n  currentIndex: 0,\n  folderSearch: ''\n};\n\nvar lbState = { zoom: 1, x: 0, y: 0, isDragging: false, lastX: 0, lastY: 0, startX: 0 };\nvar saveTimeout;\n\nasync function init() {\n  var saved = await api.getState();\n  if (saved && saved.settings) state.settings = Object.assign(state.settings, saved.settings);\n  if (state.settings.zoom < 10) state.settings.zoom = [100, 150, 200, 250, 300, 400][state.settings.zoom - 1] || 200;\n  if (saved && (saved.allImages || saved.layoutData)) save(false);\n  root.getElementById('gallery-root').style.height = state.settings.height + 'px';\n  setupUI();\n  await refreshGallery();\n  setupEventListeners();\n  setupResizeObserver();\n  requestAnimationFrame(loop);\n  \n  if (state.settings.search) {\n    var input = root.getElementById('gal-search');\n    input.focus();\n    input.setSelectionRange(input.value.length, input.value.length);\n  }\n}\n\nfunction setupUI() {\n  root.getElementById('zoom-slider').value = state.settings.zoom;\n  root.getElementById('gal-search').value = state.settings.search || '';\n  root.getElementById('btn-toggle-names').classList.toggle('active', state.settings.showNames);\n  updateLayoutButtons();\n  updateMetrics();\n  root.getElementById('opt-include-all').checked = state.settings.includeAll;\n  root.getElementById('opt-sort-by').value = state.settings.sortBy;\n}\n\nfunction updateLayoutButtons() {\n  root.getElementById('btn-layout-square').classList.toggle('active', state.settings.layout === 'square');\n  root.getElementById('btn-layout-justified').classList.toggle('active', state.settings.layout === 'justified');\n}\n\nfunction updateMetrics() {\n  var rect = canvas.getBoundingClientRect();\n  if (rect.width === 0) return;\n  canvas.width = rect.width * window.devicePixelRatio;\n  canvas.height = rect.height * window.devicePixelRatio;\n  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);\n  state.rowHeight = state.settings.zoom;\n  calculateLayout();\n}\n\nfunction calculateLayout() {\n  var rect = canvas.getBoundingClientRect();\n  var width = rect.width;\n  if (width === 0) return;\n  state.layoutData = [];\n  var textH = state.settings.showNames ? 25 : 0;\n  \n  if (state.settings.layout === 'square') {\n    var cols = Math.max(1, Math.floor((width - state.gap) / (state.rowHeight + state.gap)));\n    var itemW = (width - (cols + 1) * state.gap) / cols;\n    state.filteredImages.forEach((img, i) => {\n      var col = i % cols, row = Math.floor(i / cols);\n      state.layoutData.push({ x: state.gap + col * (itemW + state.gap), y: state.gap + row * (itemW + state.gap + textH), w: itemW, h: itemW });\n    });\n  } else {\n    var currentRow = [], currentRowWidth = 0, y = state.gap;\n    state.filteredImages.forEach((imgData, i) => {\n      var cached = state.cache.get(imgData.path);\n      var aspect = (cached && cached.width) ? cached.width / cached.height : 1.5;\n      var itemW = state.rowHeight * aspect;\n      if (currentRowWidth + itemW + state.gap > width - state.gap && currentRow.length > 0) {\n        var scale = (width - (currentRow.length + 1) * state.gap) / currentRowWidth;\n        var x = state.gap;\n        currentRow.forEach(item => { item.w *= scale; item.h *= scale; item.x = x; item.y = y; x += item.w + state.gap; });\n        y += currentRow[0].h + state.gap + textH; currentRow = []; currentRowWidth = 0;\n      }\n      var item = { x: 0, y: 0, w: itemW, h: state.rowHeight, index: i };\n      currentRow.push(item); state.layoutData.push(item); currentRowWidth += itemW;\n    });\n    var lx = state.gap;\n    currentRow.forEach(item => { item.x = lx; item.y = y; lx += item.w + state.gap; });\n  }\n}\n\nasync function refreshGallery() {\n  if (!app) return;\n  var allFiles = app.vault.getFiles();\n  var imgExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'];\n  state.allImages = allFiles.filter(f => imgExtensions.includes(f.extension.toLowerCase())).map(f => ({\n    name: f.name, path: f.path, url: app.vault.getResourcePath(f), mtime: f.stat.mtime, ctime: f.stat.ctime, size: f.stat.size\n  }));\n  sortImages(); applyFilter(); updateScrubber(); updateFolderList();\n}\n\nfunction sortImages() {\n  var mode = state.settings.sortBy;\n  state.allImages.sort((a, b) => {\n    if (mode === 'mtime-desc') return b.mtime - a.mtime;\n    if (mode === 'mtime-asc') return a.mtime - b.mtime;\n    if (mode === 'ctime-desc') return b.ctime - a.ctime;\n    if (mode === 'name-asc') return a.name.localeCompare(b.name);\n    if (mode === 'size-desc') return b.size - a.size;\n    return 0;\n  });\n}\n\nfunction applyFilter() {\n  var query = (state.settings.search || '').toLowerCase();\n  state.filteredImages = state.allImages.filter(img => {\n    var inFolder = state.settings.includeAll || state.settings.folders.some(f => img.path.startsWith(f));\n    var matchesSearch = !query || img.name.toLowerCase().includes(query);\n    return inFolder && matchesSearch;\n  });\n  calculateLayout();\n}\n\nfunction loop() {\n  render();\n  requestAnimationFrame(loop);\n}\n\nfunction render() {\n  var rect = canvas.getBoundingClientRect();\n  if (rect.width === 0) return;\n  if (!state.isDragging) {\n    state.scroll += (state.targetScroll - state.scroll) * 0.15;\n    if (Math.abs(state.targetScroll - state.scroll) < 0.1) state.scroll = state.targetScroll;\n  }\n  ctx.fillStyle = '#000';\n  ctx.fillRect(0, 0, rect.width, rect.height);\n  state.layoutData.forEach((layout, i) => {\n    var y = layout.y - state.scroll;\n    if (y + layout.h + 30 < 0 || y > rect.height) return;\n    drawItem(state.filteredImages[i], layout.x, y, layout.w, layout.h);\n  });\n}\n\nfunction drawItem(imgData, x, y, w, h) {\n  var cached = state.cache.get(imgData.path);\n  var isSelected = state.selection.has(imgData.path);\n  if (!cached) {\n    var img = new Image(); img.src = imgData.url; img.onload = () => { state.cache.set(imgData.path, img); calculateLayout(); };\n    state.cache.set(imgData.path, 'loading'); return;\n  }\n  ctx.save(); ctx.beginPath(); ctx.roundRect(x, y, w, h, 8); ctx.clip();\n  if (cached === 'loading') { ctx.fillStyle = '#111'; ctx.fillRect(x, y, w, h); }\n  else { var iw = cached.width, ih = cached.height, r = Math.max(w / iw, h / ih), nw = iw * r, nh = ih * r; ctx.drawImage(cached, x + (w - nw) / 2, y + (h - nh) / 2, nw, nh); }\n  ctx.restore();\n  if (isSelected) { ctx.strokeStyle = state.isEditMode ? '#ff4444' : 'var(--gal-accent)'; ctx.lineWidth = 4; ctx.strokeRect(x + 2, y + 2, w - 4, h - 4); ctx.fillStyle = 'rgba(0, 210, 255, 0.2)'; ctx.fillRect(x, y, w, h); }\n  if (state.settings.showNames) { ctx.fillStyle = '#fff'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center'; var displayName = imgData.name.length > 20 ? imgData.name.substring(0, 17) + '...' : imgData.name; ctx.fillText(displayName, x + w / 2, y + h + 15); }\n}\n\nfunction setupEventListeners() {\n  var searchInput = root.getElementById('gal-search');\n  searchInput.oninput = (e) => { state.settings.search = e.target.value; applyFilter(); save(false); };\n  root.getElementById('btn-clear-search').onclick = () => { state.settings.search = ''; searchInput.value = ''; applyFilter(); save(true); searchInput.focus(); };\n\n  // Robust Drag & Click Handling\n  canvas.onpointerdown = (e) => {\n    state.isPointerDown = true;\n    state.startY = e.clientY;\n    state.startScroll = state.scroll;\n    state.hasMoved = false;\n    canvas.setPointerCapture(e.pointerId);\n  };\n\n  canvas.onpointermove = (e) => {\n    if (!state.isPointerDown) return;\n    var delta = e.clientY - state.startY;\n    if (Math.abs(delta) > 5) state.hasMoved = true;\n    if (state.hasMoved) {\n      state.isDragging = true;\n      state.targetScroll = state.startScroll - delta;\n      state.scroll = state.targetScroll;\n      clampScroll();\n    }\n  };\n\n  canvas.onpointerup = (e) => {\n    if (!state.isPointerDown) return;\n    state.isPointerDown = false;\n    state.isDragging = false;\n    canvas.releasePointerCapture(e.pointerId);\n    if (!state.hasMoved) handleCanvasClick(e);\n    else clampScroll();\n  };\n\n  canvas.onpointercancel = (e) => {\n    state.isPointerDown = false;\n    state.isDragging = false;\n    canvas.releasePointerCapture(e.pointerId);\n  };\n\n  canvas.onwheel = (e) => { \n    e.preventDefault(); \n    if (e.ctrlKey) {\n      var delta = e.deltaY * -0.5;\n      var newZoom = Math.max(50, Math.min(state.settings.zoom + delta, 1000));\n      state.settings.zoom = newZoom;\n      state.rowHeight = newZoom;\n      root.getElementById('zoom-slider').value = newZoom;\n      calculateLayout();\n      save(false);\n    } else {\n      state.targetScroll += e.deltaY; \n      clampScroll(); \n    }\n  };\n\n  // Prevent context menu to allow right click usage\n  canvas.oncontextmenu = (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    return false;\n  };\n\n  function handleCanvasClick(e) {\n    var rect = canvas.getBoundingClientRect();\n    var mx = e.clientX - rect.left, my = e.clientY - rect.top + state.scroll;\n    var hit = state.layoutData.find(l => mx >= l.x && mx <= l.x + l.w && my >= l.y && my <= l.y + l.h);\n    if (!hit) return;\n    var img = state.filteredImages[state.layoutData.indexOf(hit)];\n    \n    // Right click (button 2) opens lightbox\n    if (e.button === 2) {\n        if (!state.isEditMode) openLightbox(img.path);\n        return;\n    }\n\n    // Left click (button 0) handles selection\n    if (e.button === 0) {\n        if (state.isEditMode) {\n          if (state.selection.has(img.path)) state.selection.delete(img.path);\n          else state.selection.add(img.path);\n          updateEditToolbar();\n        } else {\n          state.selection.clear();\n          state.selection.add(img.path);\n        }\n    }\n  }\n\n  root.getElementById('btn-toggle-names').onclick = () => { state.settings.showNames = !state.settings.showNames; root.getElementById('btn-toggle-names').classList.toggle('active', state.settings.showNames); calculateLayout(); save(true); };\n  root.getElementById('btn-edit-mode').onclick = () => { state.isEditMode = !state.isEditMode; state.selection.clear(); root.getElementById('btn-edit-mode').classList.toggle('active', state.isEditMode); updateEditToolbar(); };\n  root.getElementById('btn-cancel-edit').onclick = () => { state.isEditMode = false; state.selection.clear(); root.getElementById('btn-edit-mode').classList.remove('active'); updateEditToolbar(); };\n  root.getElementById('btn-copy-selection').onclick = async () => {\n    var links = Array.from(state.selection).map(path => { var img = state.allImages.find(i => i.path === path); return `![[${img.name}]]`; }).join('\\n');\n    await navigator.clipboard.writeText(links); alert('Copied ' + state.selection.size + ' links!');\n  };\n  root.getElementById('btn-delete-selection').onclick = async () => {\n    if (!confirm(`Delete ${state.selection.size} images?`)) return;\n    for (let path of state.selection) { var file = app.vault.getAbstractFileByPath(path); if (file) await app.vault.trash(file, true); }\n    state.selection.clear(); state.isEditMode = false; root.getElementById('btn-edit-mode').classList.remove('active'); updateEditToolbar(); await refreshGallery();\n  };\n  root.getElementById('btn-lb-copy').onclick = async () => { var path = root.getElementById('lightbox-img').dataset.path; var img = state.allImages.find(i => i.path === path); await navigator.clipboard.writeText(`![[${img.name}]]`); alert('Copied!'); };\n  \n  var lb = root.getElementById('lightbox'), lbContent = root.getElementById('lightbox-content');\n  lbContent.onwheel = (e) => { e.preventDefault(); var delta = e.deltaY > 0 ? 0.9 : 1.1; lbState.zoom = Math.max(0.5, Math.min(lbState.zoom * delta, 10)); updateLightboxTransform(); };\n  lbContent.onpointerdown = (e) => { \n    lbState.isDragging = true; \n    lbState.startX = e.clientX;\n    lbState.lastX = e.clientX; \n    lbState.lastY = e.clientY; \n    lbContent.setPointerCapture(e.pointerId); \n  };\n  lbContent.onpointermove = (e) => { \n    if (!lbState.isDragging) return; \n    lbState.x += e.clientX - lbState.lastX; \n    lbState.y += e.clientY - lbState.lastY; \n    lbState.lastX = e.clientX; \n    lbState.lastY = e.clientY; \n    updateLightboxTransform(); \n  };\n  lbContent.onpointerup = (e) => { \n    lbState.isDragging = false; \n    lbContent.releasePointerCapture(e.pointerId); \n    if (lbState.zoom === 1) {\n        var dx = e.clientX - lbState.startX;\n        if (dx > 50) navigateLightbox(-1);\n        else if (dx < -50) navigateLightbox(1);\n        else { lbState.x = 0; lbState.y = 0; updateLightboxTransform(); }\n    }\n  };\n  \n  root.getElementById('btn-lb-prev').onclick = (e) => { e.stopPropagation(); navigateLightbox(-1); };\n  root.getElementById('btn-lb-next').onclick = (e) => { e.stopPropagation(); navigateLightbox(1); };\n\n  root.getElementById('zoom-slider').oninput = (e) => { state.settings.zoom = parseInt(e.target.value); updateMetrics(); save(true); };\n  root.getElementById('btn-layout-square').onclick = () => { state.settings.layout = 'square'; updateLayoutButtons(); calculateLayout(); save(true); };\n  root.getElementById('btn-layout-justified').onclick = () => { state.settings.layout = 'justified'; updateLayoutButtons(); calculateLayout(); save(true); };\n  root.getElementById('btn-fullscreen').onclick = () => { var container = root.getElementById('gallery-root'); if (!document.fullscreenElement) container.requestFullscreen().catch(() => container.classList.add('fullscreen')); else document.exitFullscreen(); };\n  document.addEventListener('fullscreenchange', () => { \n    var isFs = !!document.fullscreenElement;\n    root.getElementById('gallery-root').classList.toggle('fullscreen', isFs); \n    setTimeout(updateMetrics, 100);\n    if (!isFs && state.pendingSave) { state.pendingSave = false; save(true); }\n  });\n  lb.onclick = (e) => { if (e.target === lb || e.target === lbContent) closeLightbox(); };\n  root.querySelector('.lightbox-close').onclick = closeLightbox;\n  \n  // New folder popup logic\n  var folderBtn = root.getElementById('btn-folders');\n  var folderPopup = root.getElementById('folder-popup');\n  folderBtn.onclick = (e) => { e.stopPropagation(); folderPopup.classList.toggle('active'); folderBtn.classList.toggle('active', folderPopup.classList.contains('active')); };\n  folderPopup.onclick = (e) => e.stopPropagation();\n  document.addEventListener('click', (e) => { if (folderPopup.classList.contains('active') && !folderBtn.contains(e.target)) { folderPopup.classList.remove('active'); folderBtn.classList.remove('active'); } });\n  \n  root.getElementById('folder-search').oninput = (e) => { state.folderSearch = e.target.value.toLowerCase(); updateFolderList(); };\n\n  root.getElementById('opt-include-all').onchange = (e) => { state.settings.includeAll = e.target.checked; save(true); refreshGallery(); };\n  root.getElementById('opt-sort-by').onchange = (e) => { state.settings.sortBy = e.target.value; save(true); sortImages(); applyFilter(); };\n\n  // Help Logic\n  root.getElementById('btn-help').onclick = () => { root.getElementById('help-modal').style.display = 'flex'; };\n  root.getElementById('btn-close-help').onclick = () => { root.getElementById('help-modal').style.display = 'none'; };\n\n  // Add to Note Logic\n  root.getElementById('btn-add-to-note').onclick = () => { root.getElementById('note-selector-modal').style.display = 'flex'; root.getElementById('note-search').focus(); updateNoteList(''); };\n  root.getElementById('btn-close-note-modal').onclick = () => { root.getElementById('note-selector-modal').style.display = 'none'; };\n  root.getElementById('note-search').oninput = (e) => updateNoteList(e.target.value);\n}\n\nfunction updateNoteList(query) {\n  var list = root.getElementById('note-list');\n  var files = app.vault.getMarkdownFiles().filter(f => f.path.toLowerCase().includes(query.toLowerCase()));\n  list.innerHTML = files.slice(0, 50).map(f => `<div class=\"note-item\" data-path=\"${f.path}\">${f.path}</div>`).join('');\n  list.classList.add('active');\n  list.querySelectorAll('.note-item').forEach(item => {\n    item.onclick = async () => {\n      var file = app.vault.getAbstractFileByPath(item.dataset.path);\n      var links = Array.from(state.selection).map(path => { var img = state.allImages.find(i => i.path === path); return `![[${img.name}]]`; }).join('\\n');\n      var content = await app.vault.read(file);\n      await app.vault.modify(file, content + '\\n' + links);\n      alert('Added to note!');\n      root.getElementById('note-selector-modal').style.display = 'none';\n      state.isEditMode = false; root.getElementById('btn-edit-mode').classList.remove('active'); updateEditToolbar();\n    };\n  });\n}\n\nfunction navigateLightbox(dir) {\n    var newIndex = state.currentIndex + dir;\n    if (newIndex < 0) newIndex = state.filteredImages.length - 1;\n    if (newIndex >= state.filteredImages.length) newIndex = 0;\n    openLightbox(state.filteredImages[newIndex].path);\n}\n\nfunction handleKey(e) {\n    if (root.getElementById('lightbox').style.display !== 'flex') return;\n    if (e.key === 'ArrowLeft') navigateLightbox(-1);\n    if (e.key === 'ArrowRight') navigateLightbox(1);\n    if (e.key === 'Escape') closeLightbox();\n}\n\nfunction updateLightboxTransform() { var lbImg = root.getElementById('lightbox-img'); lbImg.style.transform = `translate(${lbState.x}px, ${lbState.y}px) scale(${lbState.zoom})`; }\nfunction updateEditToolbar() { \n    var bar = root.getElementById('edit-toolbar'); \n    bar.classList.toggle('active', state.isEditMode); \n    root.getElementById('selection-count').innerText = state.selection.size;\n}\nfunction setupResizeObserver() { var container = root.getElementById('gallery-root'); var observer = new ResizeObserver(entries => { for (let entry of entries) { if (document.fullscreenElement) return; var h = Math.round(entry.contentRect.height); if (h > 0 && h !== state.settings.height) { state.settings.height = h; save(true); updateMetrics(); } } }); observer.observe(container); }\nfunction clampScroll() { var rect = canvas.getBoundingClientRect(); var lastItem = state.layoutData[state.layoutData.length - 1], textH = state.settings.showNames ? 25 : 0;\n  var maxScroll = lastItem ? Math.max(0, lastItem.y + lastItem.h + state.gap + textH - rect.height) : 0; state.targetScroll = Math.max(0, Math.min(state.targetScroll, maxScroll)); }\nfunction updateScrubber() { var track = root.getElementById('scrubber-track'); if (state.filteredImages.length < 10) { track.innerHTML = ''; return; } var years = new Set(); state.filteredImages.forEach(img => years.add(new Date(img.mtime).getFullYear()));\n  var markers = Array.from(years).sort((a,b)=>b-a).map(y => ({ label: y, index: state.filteredImages.findIndex(img => new Date(img.mtime).getFullYear() === y) }));\n  track.innerHTML = markers.map(m => `<div class=\"scrubber-point\" data-label=\"${m.label}\" data-index=\"${m.index}\"></div>`).join('');\n  track.querySelectorAll('.scrubber-point').forEach(p => { p.onclick = () => { var layout = state.layoutData[parseInt(p.dataset.index)]; if (layout) { state.targetScroll = layout.y - state.gap; clampScroll(); } }; }); }\nfunction updateFolderList() { \n  if (!app) return; \n  var folders = new Set(); \n  app.vault.getFiles().forEach(f => { var parts = f.path.split('/'); if (parts.length > 1) folders.add(parts.slice(0, -1).join('/')); });\n  var sortedFolders = Array.from(folders).sort((a, b) => {\n      var aSel = state.settings.folders.includes(a) ? 1 : 0;\n      var bSel = state.settings.folders.includes(b) ? 1 : 0;\n      return (bSel - aSel) || a.localeCompare(b);\n  });\n  if (state.folderSearch) sortedFolders = sortedFolders.filter(f => f.toLowerCase().includes(state.folderSearch));\n  \n  var list = root.getElementById('folder-list'); \n  list.innerHTML = sortedFolders.map(f => { \n      var checked = state.settings.folders.indexOf(f) !== -1 ? 'checked' : ''; \n      var selClass = checked ? 'selected' : '';\n      return `<div class=\"folder-item ${selClass}\"><input type=\"checkbox\" class=\"folder-check\" data-folder=\"${f}\" ${checked}><span>${f}</span></div>`; \n  }).join('');\n  \n  list.querySelectorAll('.folder-check').forEach(cb => { \n      cb.onchange = () => { \n          var folder = cb.dataset.folder; \n          if (cb.checked) { if (state.settings.folders.indexOf(folder) === -1) state.settings.folders.push(folder); } \n          else { state.settings.folders = state.settings.folders.filter(x => x !== folder); } \n          save(true); \n          applyFilter(); \n          updateFolderList(); \n      }; \n  }); \n}\nfunction openLightbox(path) { \n    var index = state.filteredImages.findIndex(x => x.path === path);\n    if (index === -1) return;\n    state.currentIndex = index;\n    var img = state.filteredImages[index];\n    var lb = root.getElementById('lightbox'), lbImg = root.getElementById('lightbox-img');\n    lbImg.src = img.url; lbImg.dataset.path = img.path; lbState.zoom = 1; lbState.x = 0; lbState.y = 0; updateLightboxTransform();\n    root.getElementById('lightbox-name').innerText = img.name; \n    root.getElementById('lightbox-meta').innerText = (img.size / 1024 / 1024).toFixed(2) + ' MB ‚Ä¢ ' + new Date(img.mtime).toLocaleString(); \n    lb.style.display = 'flex'; \n    document.addEventListener('keydown', handleKey);\n}\nfunction closeLightbox() {\n    root.getElementById('lightbox').style.display = 'none';\n    document.removeEventListener('keydown', handleKey);\n}\nfunction save(immediate) { \n  if (document.fullscreenElement) { state.pendingSave = true; return; }\n  var clean = { settings: state.settings }; \n  if (immediate) { api.saveState(clean); return; } \n  clearTimeout(saveTimeout); \n  saveTimeout = setTimeout(() => api.saveState(clean), 2000); \n}\ninit();",
    "tags": [
        "media",
        "gallery",
        "photos",
        "vault",
        "visual",
        "modern",
        "gpu",
        "search",
        "edit",
        "zoom"
    ]
}