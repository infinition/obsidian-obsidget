export default {
  "id": "jukebox",
  "name": "Jukebox",
  "description": "Lecteur audio pour le vault : lire les morceaux d'un ou plusieurs dossiers, mode aléatoire, contrôles complets et mémorisation de la piste / progression.",
  "author": "Infinition",
  "authorUrl": "https://github.com/infinition",
  "data": {
    "settings": {
      "folders": [],
      "includeAll": true,
      "shuffle": false,
      "volume": 80,
      "sortBy": "name-asc"
    }
  },
  "html": "<div class=\"jukebox-container\" id=\"jukebox-root\">\n  <div class=\"jukebox-header\">\n    <div class=\"header-left\">\n      <div class=\"folder-wrapper\">\n        <button class=\"icon-btn\" id=\"btn-folders\" title=\"Dossiers\">\n          <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"></path></svg>\n        </button>\n        <div id=\"folder-popup\" class=\"folder-popup\">\n          <div class=\"popup-header\">\n            <input type=\"text\" id=\"folder-search\" placeholder=\"Filtrer dossiers...\" class=\"folder-search-input\">\n            <label class=\"checkbox-label\"><input type=\"checkbox\" id=\"opt-include-all\"> Tout le vault</label>\n          </div>\n          <div id=\"folder-list\" class=\"folder-list\"></div>\n        </div>\n      </div>\n      <label class=\"shuffle-toggle\">\n        <input type=\"checkbox\" id=\"opt-shuffle\">\n        <span class=\"slider\"></span>\n        <span class=\"label-text\">Aléatoire</span>\n      </label>\n    </div>\n  </div>\n\n  <div class=\"now-playing\" id=\"now-playing\">\n    <div class=\"now-playing-row\">\n      <div class=\"track-cover-wrap\">\n        <img id=\"track-cover\" class=\"track-cover\" src=\"\" alt=\"\" style=\"display:none\">\n        <div id=\"track-cover-placeholder\" class=\"track-cover-placeholder\">\n          <svg viewBox=\"0 0 24 24\" width=\"48\" height=\"48\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\"></rect><circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\"></circle><path d=\"M21 15l-5-5L5 21\"></path></svg>\n        </div>\n      </div>\n      <div class=\"now-playing-info\">\n        <div class=\"track-title\" id=\"track-title\">—</div>\n        <div class=\"progress-wrap\">\n      <input type=\"range\" id=\"progress-bar\" min=\"0\" max=\"100\" step=\"0.1\" value=\"0\">\n      <div class=\"time-labels\">\n        <span id=\"time-current\">0:00</span>\n        <span id=\"time-total\">0:00</span>\n        </div>\n      </div>\n      </div>\n    </div>\n    <div id=\"track-lyrics-wrap\" class=\"track-lyrics-wrap\" style=\"display:none\">\n      <div class=\"track-lyrics-label\">Paroles</div>\n      <div id=\"track-lyrics\" class=\"track-lyrics\"></div>\n    </div>\n  </div>\n\n  <div class=\"controls\">\n    <button class=\"ctrl-btn\" id=\"btn-prev\" title=\"Précédent\">\n      <svg viewBox=\"0 0 24 24\" width=\"22\" height=\"22\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polygon points=\"11 17 6 12 11 7\"></polygon><polygon points=\"18 17 13 12 18 7\"></polygon></svg>\n    </button>\n    <button class=\"ctrl-btn play-btn\" id=\"btn-play\" title=\"Play / Pause\">\n      <svg class=\"icon-play\" viewBox=\"0 0 24 24\" width=\"28\" height=\"28\" fill=\"currentColor\"><polygon points=\"5 3 19 12 5 21 5 3\"></polygon></svg>\n      <svg class=\"icon-pause\" viewBox=\"0 0 24 24\" width=\"28\" height=\"28\" fill=\"currentColor\" style=\"display:none\"><rect x=\"6\" y=\"4\" width=\"4\" height=\"16\"></rect><rect x=\"14\" y=\"4\" width=\"4\" height=\"16\"></rect></svg>\n    </button>\n    <button class=\"ctrl-btn\" id=\"btn-next\" title=\"Suivant\">\n      <svg viewBox=\"0 0 24 24\" width=\"22\" height=\"22\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polygon points=\"13 17 18 12 13 7\"></polygon><polygon points=\"6 17 11 12 6 7\"></polygon></svg>\n    </button>\n  </div>\n\n  <div class=\"volume-wrap\">\n    <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polygon points=\"11 5 6 9 2 9 2 15 6 15 11 19 11 5\"></polygon><path d=\"M15.54 8.46a5 5 0 0 1 0 7.07\"></path><path d=\"M19.07 4.93a10 10 0 0 1 0 14.14\"></path></svg>\n    <input type=\"range\" id=\"volume-slider\" min=\"0\" max=\"100\" value=\"80\">\n  </div>\n\n  <div class=\"playlist-wrap\">\n    <div class=\"playlist-header\"><span id=\"playlist-count\">0</span> titres</div>\n    <div id=\"playlist\" class=\"playlist\"></div>\n  </div>\n\n  <audio id=\"audio-el\" preload=\"metadata\"></audio>\n</div>",
  "css": ":host { --juke-bg: var(--background-primary); --juke-header: var(--background-secondary); --juke-accent: var(--interactive-accent); --juke-text: var(--text-normal); --juke-muted: var(--text-muted); --juke-border: var(--background-modifier-border); --juke-radius: 10px; display: flex; flex-direction: column; width: 100%; height: 100%; min-width: 0; min-height: 0; overflow: hidden; box-sizing: border-box; font-family: var(--font-interface); }\n\n.jukebox-container { flex: 1; display: flex; flex-direction: column; min-width: 0; min-height: 0; width: 100%; height: 100%; background: var(--juke-bg); border-radius: var(--juke-radius); border: 1px solid var(--juke-border); overflow: hidden; }\n\n.jukebox-header { padding: 8px 12px; background: var(--juke-header); border-bottom: 1px solid var(--juke-border); display: flex; align-items: center; gap: 10px; flex-shrink: 0; position: relative; }\n.header-left { display: flex; align-items: center; gap: 10px; }\n.folder-wrapper { position: relative; }\n.icon-btn { background: none; border: none; color: var(--juke-muted); cursor: pointer; padding: 6px; border-radius: 6px; display: flex; transition: all 0.2s; }\n.icon-btn:hover { background: var(--background-modifier-hover); color: var(--juke-text); }\n.icon-btn.active { background: var(--juke-accent); color: white; }\n\n.shuffle-toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.8rem; color: var(--juke-muted); user-select: none; }\n.shuffle-toggle input { display: none; }\n.slider { width: 32px; height: 18px; background: var(--juke-border); border-radius: 18px; position: relative; transition: background 0.2s; }\n.slider::before { content: ''; position: absolute; width: 14px; height: 14px; left: 2px; top: 2px; background: white; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }\n.shuffle-toggle input:checked + .slider { background: var(--juke-accent); }\n.shuffle-toggle input:checked + .slider::before { transform: translateX(14px); }\n.label-text { margin-left: 2px; }\n\n.folder-popup { position: absolute; top: 100%; left: 0; margin-top: 4px; width: 260px; background: var(--juke-bg); border: 1px solid var(--juke-border); border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100; display: none; flex-direction: column; overflow: hidden; }\n.folder-popup.active { display: flex; }\n.popup-header { padding: 8px 10px; border-bottom: 1px solid var(--juke-border); display: flex; flex-direction: column; gap: 8px; }\n.folder-search-input { width: 100%; background: var(--background-primary); border: 1px solid var(--juke-border); padding: 6px 8px; border-radius: 4px; color: var(--juke-text); font-size: 0.8rem; }\n.checkbox-label { font-size: 0.8rem; color: var(--juke-text); cursor: pointer; display: flex; align-items: center; gap: 6px; }\n.folder-list { max-height: 200px; overflow-y: auto; padding: 6px; }\n.folder-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; }\n.folder-item:hover { background: var(--background-modifier-hover); }\n.folder-item.selected { background: rgba(var(--interactive-accent-rgb), 0.15); color: var(--juke-accent); }\n\n.now-playing { padding: 10px 12px; border-bottom: 1px solid var(--juke-border); flex-shrink: 0; }\n.now-playing-row { display: flex; gap: 12px; align-items: flex-start; }\n.track-cover-wrap { width: 80px; height: 80px; flex-shrink: 0; border-radius: 8px; overflow: hidden; background: var(--juke-border); position: relative; }\n.track-cover { width: 100%; height: 100%; object-fit: cover; }\n.track-cover-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--juke-muted); }\n.track-cover-placeholder svg { opacity: 0.5; }\n.now-playing-info { flex: 1; min-width: 0; }\n.track-title { font-size: 0.9rem; font-weight: 600; color: var(--juke-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 8px; }\n.track-lyrics-wrap { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--juke-border); max-height: 120px; display: flex; flex-direction: column; overflow: hidden; }\n.track-lyrics-label { font-size: 0.7rem; color: var(--juke-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }\n.track-lyrics { font-size: 0.8rem; color: var(--juke-text); white-space: pre-wrap; overflow-y: auto; flex: 1; min-height: 0; line-height: 1.4; }\n.progress-wrap { display: flex; flex-direction: column; gap: 4px; }\n.progress-wrap input[type=\"range\"] { width: 100%; height: 6px; accent-color: var(--juke-accent); cursor: pointer; }\n.time-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--juke-muted); }\n\n.controls { display: flex; align-items: center; justify-content: center; gap: 16px; padding: 12px; flex-shrink: 0; border-bottom: 1px solid var(--juke-border); }\n.ctrl-btn { background: none; border: none; color: var(--juke-muted); cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }\n.ctrl-btn:hover { color: var(--juke-accent); background: var(--background-modifier-hover); }\n.play-btn { background: var(--juke-accent); color: white; width: 48px; height: 48px; }\n.play-btn:hover { opacity: 0.9; filter: brightness(1.1); }\n\n.volume-wrap { display: flex; align-items: center; gap: 8px; padding: 8px 12px; flex-shrink: 0; border-bottom: 1px solid var(--juke-border); }\n.volume-wrap svg { color: var(--juke-muted); flex-shrink: 0; }\n.volume-wrap input[type=\"range\"] { flex: 1; max-width: 120px; accent-color: var(--juke-accent); }\n\n.playlist-wrap { flex: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; }\n.playlist-header { padding: 6px 12px; font-size: 0.75rem; color: var(--juke-muted); flex-shrink: 0; }\n.playlist { flex: 1; min-height: 0; max-height: 260px; overflow-y: auto; overflow-x: hidden; padding: 4px; }\n.playlist-item { padding: 8px 10px; font-size: 0.85rem; color: var(--juke-text); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.15s; }\n.playlist-item:hover { background: var(--background-modifier-hover); }\n.playlist-item.playing { background: rgba(var(--interactive-accent-rgb), 0.15); color: var(--juke-accent); font-weight: 600; }\n.playlist-item .item-num { width: 20px; flex-shrink: 0; color: var(--juke-muted); font-size: 0.75rem; }\n.playlist-item.playing .item-num { color: var(--juke-accent); }\n.playlist-item .item-name { flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n\n#audio-el { display: none; }\n",
  "js": "var root = api.root;\nvar app = window.app || api.app;\nvar saveState = api.saveState;\nvar getState = api.getState;\n\n// Fonction utilitaire pour éviter les erreurs si root n'est pas un ShadowRoot\nfunction qs(selector) { return root.querySelector(selector); }\nfunction qsa(selector) { return root.querySelectorAll(selector); }\n\nvar AUDIO_EXT = ['mp3','ogg','wav','m4a','flac','aac','webm'];\nvar state = {\n  settings: { folders: [], includeAll: true, shuffle: false, volume: 80, sortBy: 'name-asc' },\n  allTracks: [],\n  playlistPaths: [],\n  currentIndex: 0,\n  currentTime: 0,\n  isPlaying: false,\n  folderSearch: ''\n};\nvar audio = null;\nvar progressDragging = false;\nvar saveTimeout = null;\nvar progressRafId = null;\nvar progressIntervalId = null;\n\nfunction scheduleProgressUI() {\n  if (progressRafId != null) return;\n  progressRafId = requestAnimationFrame(function() {\n    progressRafId = null;\n    if (!progressDragging && audio) updateProgressUI();\n  });\n}\n\nfunction getSettings() { return state.settings; }\n\nfunction persistImmediate() {\n  clearTimeout(saveTimeout);\n  var track = getCurrentTrack();\n  if (audio) state.currentTime = audio.currentTime;\n  saveState({\n    settings: state.settings,\n    currentIndex: state.currentIndex,\n    currentTime: state.currentTime,\n    playlistPaths: state.playlistPaths,\n    lastTrackPath: track ? track.path : null\n  });\n}\n\nfunction refreshTracks() {\n  if (!app) return;\n  var files = app.vault.getFiles();\n  state.allTracks = files\n    .filter(function(f) { return AUDIO_EXT.indexOf(f.extension.toLowerCase()) !== -1; })\n    .map(function(f) { return { name: f.name, path: f.path, url: app.vault.getResourcePath(f) }; });\n  sortTracks();\n  buildPlaylist();\n}\n\nfunction sortTracks() {\n  var by = state.settings.sortBy || 'name-asc';\n  state.allTracks.sort(function(a, b) {\n    if (by === 'name-asc') return a.name.localeCompare(b.name);\n    if (by === 'name-desc') return b.name.localeCompare(a.name);\n    return 0;\n  });\n}\n\nfunction buildPlaylist() {\n  var includeAll = state.settings.includeAll;\n  var folders = state.settings.folders || [];\n  var list = state.allTracks.filter(function(t) {\n    return includeAll || folders.some(function(f) { return t.path.indexOf(f) === 0; });\n  });\n  var paths = list.map(function(t) { return t.path; });\n  if (state.settings.shuffle) {\n    for (var i = paths.length - 1; i > 0; i--) {\n      var j = Math.floor(Math.random() * (i + 1));\n      var tmp = paths[i]; paths[i] = paths[j]; paths[j] = tmp;\n    }\n  }\n  state.playlistPaths = paths;\n  if (!state.playlistPaths.length) state.currentIndex = 0;\n  else state.currentIndex = Math.min(Math.max(0, state.currentIndex), state.playlistPaths.length - 1);\n  renderPlaylist();\n  updateNowPlaying();\n}\n\nfunction getCurrentTrack() {\n  if (!state.playlistPaths.length) return null;\n  var path = state.playlistPaths[state.currentIndex];\n  return state.allTracks.find(function(t) { return t.path === path; }) || null;\n}\n\nfunction loadTrack(index) {\n  if (!state.playlistPaths.length || !audio) return;\n  state.currentIndex = index;\n  var path = state.playlistPaths[index];\n  var track = state.allTracks.find(function(t) { return t.path === path; });\n  if (!track) return;\n  audio.src = track.url;\n  audio.load();\n  state.currentTime = 0;\n  state.isPlaying = false;\n  updateNowPlaying();\n  renderPlaylist();\n}\n\nfunction play() {\n  if (!audio || !state.playlistPaths.length) return;\n  var track = getCurrentTrack();\n  if (!track) { loadTrack(0); track = getCurrentTrack(); }\n  if (!track) return;\n  if (audio.src !== track.url) { audio.src = track.url; audio.load(); audio.currentTime = state.currentTime; }\n  audio.play().catch(function() {});\n  state.isPlaying = true;\n  updatePlayPauseUI();\n  updateMediaSession(track);\n}\n\nfunction pause() {\n  if (!audio) return;\n  audio.pause();\n  state.currentTime = audio.currentTime;\n  state.isPlaying = false;\n  updatePlayPauseUI();\n  if (navigator.mediaSession) navigator.mediaSession.playbackState = 'paused';\n  persistImmediate();\n}\n\nfunction togglePlay() {\n  if (state.isPlaying) pause(); else play();\n}\n\nfunction next() {\n  if (!state.playlistPaths.length) return;\n  var nextIdx = (state.currentIndex + 1) % state.playlistPaths.length;\n  loadTrack(nextIdx);\n  play();\n}\n\nfunction prev() {\n  if (!state.playlistPaths.length) return;\n  if (audio && audio.currentTime > 2) {\n    audio.currentTime = 0;\n    updateProgressUI();\n    return;\n  }\n  var prevIdx = state.currentIndex - 1;\n  if (prevIdx < 0) prevIdx = state.playlistPaths.length - 1;\n  loadTrack(prevIdx);\n  play();\n}\n\nfunction seek(percent) {\n  if (!audio || !Number.isFinite(audio.duration)) return;\n  audio.currentTime = (percent / 100) * audio.duration;\n  state.currentTime = audio.currentTime;\n  // Update UI immediately (but don't rely on 'timeupdate' event which might lag)\n  var timeCur = qs('#time-current');\n  if (timeCur) timeCur.textContent = formatTime(state.currentTime);\n}\n\nfunction setVolume(val) {\n  state.settings.volume = val;\n  if (audio) audio.volume = val / 100;\n}\n\nfunction formatTime(sec) {\n  if (!sec || isNaN(sec) || !isFinite(sec)) return '0:00';\n  var m = Math.floor(sec / 60);\n  var s = Math.floor(sec % 60);\n  return m + ':' + (s < 10 ? '0' : '') + s;\n}\n\nfunction updateNowPlaying() {\n  var track = getCurrentTrack();\n  var titleEl = qs('#track-title');\n  if(titleEl) titleEl.textContent = track ? track.name : '—';\n  \n  var coverEl = qs('#track-cover');\n  var placeholderEl = qs('#track-cover-placeholder');\n  var coverUrl = track ? getCoverForTrack(track) : null;\n  \n  if (coverEl && placeholderEl) {\n    if (coverUrl) {\n      coverEl.src = coverUrl;\n      coverEl.style.display = 'block';\n      placeholderEl.style.display = 'none';\n      coverEl.onerror = function() { coverEl.style.display = 'none'; coverEl.src = ''; placeholderEl.style.display = 'flex'; };\n    } else {\n      coverEl.src = '';\n      coverEl.style.display = 'none';\n      placeholderEl.style.display = 'flex';\n    }\n  }\n  \n  var lyricsWrap = qs('#track-lyrics-wrap');\n  var lyricsEl = qs('#track-lyrics');\n  if (track) {\n    getLyricsForTrack(track).then(function(text) {\n      if (text && lyricsEl) {\n        lyricsEl.textContent = text.trim();\n        if (lyricsWrap) lyricsWrap.style.display = 'flex';\n      } else {\n        if (lyricsEl) lyricsEl.textContent = '';\n        if (lyricsWrap) lyricsWrap.style.display = 'none';\n      }\n    });\n  } else {\n    if (lyricsEl) lyricsEl.textContent = '';\n    if (lyricsWrap) lyricsWrap.style.display = 'none';\n  }\n  updateProgressUI();\n}\n\nfunction updateProgressUI() {\n  var cur = audio ? audio.currentTime : 0;\n  var tot = audio && Number.isFinite(audio.duration) ? audio.duration : 0;\n  \n  var timeCur = qs('#time-current');\n  var timeTot = qs('#time-total');\n  var bar = qs('#progress-bar');\n  \n  if (timeCur) timeCur.textContent = formatTime(cur);\n  if (timeTot) timeTot.textContent = formatTime(tot);\n  \n  if (bar && !progressDragging) {\n    var pct = (tot > 0) ? (cur / tot) * 100 : 0;\n    if (isNaN(pct)) pct = 0;\n    bar.value = pct;\n  }\n}\n\nfunction updatePlayPauseUI() {\n  var playIcon = root.querySelector('.icon-play');\n  var pauseIcon = root.querySelector('.icon-pause');\n  if (playIcon) playIcon.style.display = state.isPlaying ? 'none' : 'block';\n  if (pauseIcon) pauseIcon.style.display = state.isPlaying ? 'block' : 'none';\n}\n\nfunction updateMediaSession(track) {\n  if (!navigator.mediaSession) return;\n  var coverUrl = track ? getCoverForTrack(track) : null;\n  var artwork = [];\n  if (coverUrl) artwork.push({ src: coverUrl, sizes: '512x512', type: 'image/jpeg' });\n  navigator.mediaSession.metadata = new MediaMetadata({\n    title: track.name,\n    artist: 'Jukebox',\n    album: 'Vault',\n    artwork: artwork\n  });\n  navigator.mediaSession.playbackState = state.isPlaying ? 'playing' : 'paused';\n  navigator.mediaSession.setActionHandler('play', play);\n  navigator.mediaSession.setActionHandler('pause', pause);\n  navigator.mediaSession.setActionHandler('previoustrack', prev);\n  navigator.mediaSession.setActionHandler('nexttrack', next);\n}\n\nfunction renderPlaylist() {\n  var el = qs('#playlist');\n  var countEl = qs('#playlist-count');\n  if(countEl) countEl.textContent = state.playlistPaths.length;\n  if(!el) return;\n  \n  el.innerHTML = state.playlistPaths.map(function(path, i) {\n    var track = state.allTracks.find(function(t) { return t.path === path; });\n    var name = track ? track.name : path;\n    var playing = i === state.currentIndex ? ' playing' : '';\n    return '<div class=\"playlist-item' + playing + '\" data-index=\"' + i + '\"><span class=\"item-num\">' + (i + 1) + '</span><span class=\"item-name\">' + escapeHtml(name) + '</span></div>';\n  }).join('');\n  \n  el.querySelectorAll('.playlist-item').forEach(function(item) {\n    item.onclick = function() {\n      var idx = parseInt(item.dataset.index, 10);\n      loadTrack(idx);\n      play();\n    };\n  });\n}\n\nfunction escapeHtml(s) {\n  var div = document.createElement('div');\n  div.textContent = s;\n  return div.innerHTML;\n}\n\nvar IMG_EXT = ['jpg','jpeg','png','gif','webp'];\nfunction getCoverForTrack(track) {\n  if (!app || !track) return null;\n  var parts = track.path.split('/');\n  var folder = parts.length > 1 ? parts.slice(0, -1).join('/') : '';\n  var base = track.name.replace(/\\.[^/.]+$/, '');\n  var prefix = folder ? folder + '/' : '';\n  var depth = folder ? folder.split('/').length + 1 : 1;\n  var files = app.vault.getFiles().filter(function(f) {\n    if (!f.path.startsWith(prefix) || f.path.split('/').length !== depth) return false;\n    var name = f.path.slice(prefix.length);\n    var ext = (name.split('.').pop() || '').toLowerCase();\n    if (IMG_EXT.indexOf(ext) === -1) return false;\n    var baseName = name.replace(/\\.[^/.]+$/, '').toLowerCase();\n    return baseName === 'cover' || baseName === 'folder' || baseName === 'album' || baseName === 'front' || baseName === base.toLowerCase();\n  });\n  if (files.length) return app.vault.getResourcePath(files[0]);\n  return null;\n}\n\nfunction getLyricsForTrack(track) {\n  if (!app || !track) return Promise.resolve(null);\n  var parts = track.path.split('/');\n  var folder = parts.length > 1 ? parts.slice(0, -1).join('/') : '';\n  var base = track.name.replace(/\\.[^/.]+$/, '');\n  var names = [base + '.lrc', base + '.txt'];\n  var candidates = [];\n  for (var i = 0; i < names.length; i++) {\n    candidates.push(folder ? folder + '/' + names[i] : names[i]);\n  }\n  for (var j = 0; j < candidates.length; j++) {\n    var path = candidates[j];\n    var file = app.vault.getAbstractFileByPath(path);\n    if (file && typeof file.extension !== 'undefined') {\n      return app.vault.read(file).then(function(t) { return t; }).catch(function() { return null; });\n    }\n  }\n  return Promise.resolve(null);\n}\n\nfunction updateFolderList() {\n  if (!app) return;\n  var folders = new Set();\n  state.allTracks.forEach(function(t) {\n    var parts = t.path.split('/');\n    if (parts.length > 1) folders.add(parts.slice(0, -1).join('/'));\n  });\n  var list = Array.from(folders).sort();\n  if (state.folderSearch) list = list.filter(function(f) { return f.toLowerCase().indexOf(state.folderSearch.toLowerCase()) !== -1; });\n  var html = list.map(function(f) {\n    var sel = (state.settings.folders || []).indexOf(f) !== -1;\n    return '<div class=\"folder-item' + (sel ? ' selected' : '') + '\"><input type=\"checkbox\" class=\"folder-cb\" data-folder=\"' + escapeHtml(f) + '\"' + (sel ? ' checked' : '') + '><span>' + escapeHtml(f) + '</span></div>';\n  }).join('');\n  \n  var listEl = qs('#folder-list');\n  if (listEl) {\n    listEl.innerHTML = html;\n    listEl.querySelectorAll('.folder-cb').forEach(function(cb) {\n      cb.onchange = function() {\n        var folder = cb.dataset.folder;\n        var arr = state.settings.folders || [];\n        if (cb.checked) {\n          if (arr.indexOf(folder) === -1) arr.push(folder);\n        } else arr = arr.filter(function(x) { return x !== folder; });\n        state.settings.folders = arr;\n        state.settings.includeAll = false;\n        var incEl = qs('#opt-include-all');\n        if(incEl) incEl.checked = false;\n        buildPlaylist();\n        persistImmediate();\n      };\n    });\n  }\n}\n\nasync function init() {\n  audio = qs('#audio-el');\n  if (!audio) return;\n\n  var savedLastTrackPath = null;\n  try {\n    var saved = await getState();\n    if (saved) {\n      if (saved.settings) state.settings = Object.assign(state.settings, saved.settings);\n      if (typeof saved.currentIndex === 'number') state.currentIndex = saved.currentIndex;\n      if (typeof saved.currentTime === 'number') state.currentTime = saved.currentTime;\n      if (Array.isArray(saved.playlistPaths)) state.playlistPaths = saved.playlistPaths;\n      if (saved.lastTrackPath) savedLastTrackPath = saved.lastTrackPath;\n    }\n  } catch (e) {}\n\n  var incEl = qs('#opt-include-all');\n  if(incEl) {\n      incEl.checked = state.settings.includeAll;\n      incEl.onchange = function() {\n        state.settings.includeAll = this.checked;\n        if (this.checked) state.settings.folders = [];\n        buildPlaylist();\n        updateFolderList();\n        persistImmediate();\n      };\n  }\n\n  var shuffleEl = qs('#opt-shuffle');\n  if(shuffleEl) {\n      shuffleEl.checked = state.settings.shuffle;\n      shuffleEl.onchange = function() {\n        state.settings.shuffle = this.checked;\n        buildPlaylist();\n        persistImmediate();\n      };\n  }\n  \n  var volEl = qs('#volume-slider');\n  if(volEl) {\n      volEl.value = state.settings.volume;\n      volEl.oninput = function() { setVolume(parseInt(this.value, 10)); };\n      volEl.onchange = function() { persistImmediate(); };\n  }\n  \n  audio.volume = state.settings.volume / 100;\n\n  refreshTracks();\n  if (savedLastTrackPath && state.playlistPaths.length) {\n    var idx = state.playlistPaths.indexOf(savedLastTrackPath);\n    if (idx !== -1) state.currentIndex = idx;\n  }\n\n  if (state.playlistPaths.length && state.currentIndex >= 0 && state.currentIndex < state.playlistPaths.length) {\n    var path = state.playlistPaths[state.currentIndex];\n    var track = state.allTracks.find(function(t) { return t.path === path; });\n    if (track) {\n      audio.src = track.url;\n      audio.load();\n      audio.currentTime = state.currentTime;\n    }\n  }\n  updateNowPlaying();\n  updatePlayPauseUI();\n\n  var btnPlay = qs('#btn-play');\n  if(btnPlay) btnPlay.onclick = togglePlay;\n  var btnPrev = qs('#btn-prev');\n  if(btnPrev) btnPrev.onclick = prev;\n  var btnNext = qs('#btn-next');\n  if(btnNext) btnNext.onclick = next;\n\n  var bar = qs('#progress-bar');\n  if(bar) {\n      bar.oninput = function() {\n        progressDragging = true;\n        seek(parseFloat(this.value));\n      };\n      bar.onchange = function() {\n        progressDragging = false;\n        if (audio) { state.currentTime = audio.currentTime; persistImmediate(); }\n      };\n  }\n\n  var folderBtn = qs('#btn-folders');\n  var folderPopup = qs('#folder-popup');\n  if(folderBtn && folderPopup) {\n      folderBtn.onclick = function(e) {\n        e.stopPropagation();\n        folderPopup.classList.toggle('active');\n        folderBtn.classList.toggle('active', folderPopup.classList.contains('active'));\n        updateFolderList();\n      };\n      folderPopup.onclick = function(e) { e.stopPropagation(); };\n      root.addEventListener('click', function(e) {\n        if (folderPopup.classList.contains('active') && !folderPopup.contains(e.target) && !folderBtn.contains(e.target)) {\n          folderPopup.classList.remove('active');\n          folderBtn.classList.remove('active');\n        }\n      });\n  }\n  \n  var fSearch = qs('#folder-search');\n  if(fSearch) {\n    fSearch.oninput = function() {\n        state.folderSearch = this.value;\n        updateFolderList();\n    };\n  }\n\n  audio.ontimeupdate = function() {\n    state.currentTime = audio.currentTime;\n    scheduleProgressUI();\n  };\n  audio.onended = function() {\n    next();\n  };\n  audio.onloadedmetadata = function() {\n    updateProgressUI();\n  };\n  audio.onerror = function() {\n    state.isPlaying = false;\n    updatePlayPauseUI();\n  };\n  \n  if(progressIntervalId) clearInterval(progressIntervalId);\n  progressIntervalId = setInterval(function() {\n    if (state.isPlaying && audio && !progressDragging) scheduleProgressUI();\n  }, 250);\n}\n\ninit();",
  "tags": [
    "audio",
    "music",
    "vault",
    "playlist",
    "shuffle",
    "media"
  ],
  "lastModifiedDate": 1769807046600,
  "createdDate": 1769807046600
};