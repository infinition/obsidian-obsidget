{
  "id": "pomodoro-timer",
  "name": "Pomodoro Timer",
  "description": "Stay focused with a customizable Pomodoro timer.",
  "author": "Infinition",
  "authorUrl": "https://github.com/infinition",
  "html": "<div class=\"widget-card\" id=\"pomo-card\">\n  <div class=\"header-actions\">\n    <button class=\"btn-icon\" id=\"btn-pip\" title=\"Picture in Picture\">üì∫</button>\n    <button class=\"btn-icon\" id=\"btn-settings\" title=\"Settings\">‚öôÔ∏è</button>\n  </div>\n\n  <div class=\"timer-modes\">\n    <button class=\"mode-btn active\" id=\"mode-pomo\">Pomodoro</button>\n    <button class=\"mode-btn\" id=\"mode-short\">Short Break</button>\n    <button class=\"mode-btn\" id=\"mode-long\">Long Break</button>\n  </div>\n  \n  <div class=\"timer-display\" id=\"timer-display\">25:00</div>\n  \n  <div class=\"controls\">\n    <button class=\"btn-main\" id=\"start-btn\">START</button>\n    <button class=\"btn-reset\" id=\"reset-btn\" title=\"Reset\">‚Üª</button>\n  </div>\n  \n  <div class=\"stats\">\n    <div class=\"session-info\">\n      Sessions: <b id=\"session-count\">0</b>\n    </div>\n    <button class=\"btn-clear\" id=\"btn-clear\">Clear Stats</button>\n  </div>\n\n  <div class=\"settings-overlay\" id=\"settings-overlay\">\n    <div class=\"settings-content\">\n      <div class=\"settings-header\">\n        <h3>Settings</h3>\n        <button class=\"btn-icon\" id=\"btn-close-settings\">‚úï</button>\n      </div>\n      \n      <div class=\"settings-group\">\n        <label>Time (minutes)</label>\n        <div class=\"input-row\">\n          <div class=\"input-field\">\n            <span>Pomo</span>\n            <input type=\"number\" id=\"input-pomo\" min=\"1\" max=\"60\" value=\"25\">\n          </div>\n          <div class=\"input-field\">\n            <span>Short</span>\n            <input type=\"number\" id=\"input-short\" min=\"1\" max=\"30\" value=\"5\">\n          </div>\n          <div class=\"input-field\">\n            <span>Long</span>\n            <input type=\"number\" id=\"input-long\" min=\"1\" max=\"60\" value=\"15\">\n          </div>\n        </div>\n      </div>\n\n      <div class=\"settings-group\">\n        <div class=\"toggle-row\">\n          <label>Sound Alert</label>\n          <label class=\"switch\">\n            <input type=\"checkbox\" id=\"toggle-sound\" checked>\n            <span class=\"slider\"></span>\n          </label>\n        </div>\n        <div class=\"toggle-row\" style=\"margin-top: 12px;\">\n          <label>Auto PiP on Start</label>\n          <label class=\"switch\">\n            <input type=\"checkbox\" id=\"toggle-autopip\">\n            <span class=\"slider\"></span>\n          </label>\n        </div>\n      </div>\n\n      <button class=\"btn-save\" id=\"btn-save-settings\">SAVE</button>\n    </div>\n  </div>\n  \n  <canvas id=\"pip-canvas\" width=\"300\" height=\"150\" style=\"display:none\"></canvas>\n  <video id=\"pip-video\" autoplay muted loop style=\"display:none\"></video>\n  <audio id=\"silent-audio\" loop style=\"display:none\">\n    <source src=\"data:audio/wav;base64,UklGRigAAABXQVZFRm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==\" type=\"audio/wav\">\n  </audio>\n</div>",
  "css": ":host { display: block; font-family: var(--font-interface); }\n* { box-sizing: border-box; }\n\n.widget-card {\n    background: #ba4949;\n    color: white;\n    border-radius: 32px;\n    padding: 1.5rem;\n    text-align: center;\n    transition: background 0.5s cubic-bezier(0.4, 0, 0.2, 1);\n    box-shadow: 0 15px 35px rgba(0,0,0,0.2);\n    position: relative;\n    overflow: hidden;\n    width: 100%;\n}\n\n.header-actions {\n    display: flex;\n    justify-content: flex-end;\n    gap: 8px;\n    margin-bottom: 0.5rem;\n}\n\n.btn-icon {\n    background: rgba(255,255,255,0.15);\n    border: none;\n    color: white;\n    width: 32px;\n    height: 32px;\n    border-radius: 8px;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1rem;\n    transition: all 0.2s;\n}\n.btn-icon:hover { background: rgba(255,255,255,0.25); }\n\n.timer-modes {\n    display: flex;\n    justify-content: center;\n    gap: 8px;\n    margin-bottom: 1.5rem;\n}\n\n.mode-btn {\n    background: transparent;\n    border: none;\n    color: white;\n    padding: 8px 16px;\n    border-radius: 12px;\n    font-weight: 700;\n    font-size: 0.85rem;\n    cursor: pointer;\n    transition: all 0.2s;\n    opacity: 0.7;\n}\n.mode-btn.active {\n    background: rgba(0,0,0,0.15);\n    opacity: 1;\n}\n.mode-btn:hover { opacity: 1; }\n\n.timer-display {\n    font-size: 5.5rem;\n    font-weight: 800;\n    font-family: var(--font-monospace);\n    margin: 1rem 0 2rem;\n    line-height: 1;\n    letter-spacing: -2px;\n    text-shadow: 0 4px 10px rgba(0,0,0,0.1);\n}\n\n.controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 20px;\n    margin-bottom: 1.5rem;\n}\n\n.btn-main {\n    background: white;\n    color: #ba4949;\n    border: none;\n    padding: 14px 40px;\n    border-radius: 16px;\n    font-size: 1.4rem;\n    font-weight: 900;\n    cursor: pointer;\n    box-shadow: 0 6px 0 rgba(0,0,0,0.1);\n    transition: all 0.1s;\n    text-transform: uppercase;\n    letter-spacing: 1px;\n}\n.btn-main:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }\n\n.btn-reset {\n    background: rgba(255,255,255,0.15);\n    border: none;\n    color: white;\n    width: 48px;\n    height: 48px;\n    border-radius: 16px;\n    font-size: 1.5rem;\n    cursor: pointer;\n    transition: all 0.2s;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n.btn-reset:hover { background: rgba(255,255,255,0.25); transform: rotate(-45deg); }\n\n.stats {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding-top: 1rem;\n    border-top: 1px solid rgba(255,255,255,0.1);\n    font-size: 0.85rem;\n    font-weight: 600;\n}\n\n.session-info { opacity: 0.8; }\n.btn-clear {\n    background: none;\n    border: none;\n    color: white;\n    text-decoration: underline;\n    cursor: pointer;\n    opacity: 0.6;\n    font-size: 0.75rem;\n}\n.btn-clear:hover { opacity: 1; }\n\n/* Settings Overlay */\n.settings-overlay {\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0,0,0,0.8);\n    backdrop-filter: blur(10px);\n    display: none;\n    align-items: center;\n    justify-content: center;\n    z-index: 100;\n    padding: 1rem;\n}\n.settings-overlay.show { display: flex; }\n\n.settings-content {\n    background: var(--background-primary);\n    color: var(--text-normal);\n    width: 100%;\n    max-width: 280px;\n    border-radius: 24px;\n    padding: 1.5rem;\n    box-shadow: 0 20px 50px rgba(0,0,0,0.3);\n}\n\n.settings-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 1.5rem;\n}\n.settings-header h3 {\n    margin: 0;\n    font-size: 1.1rem;\n    color: var(--text-muted);\n    text-transform: uppercase;\n    letter-spacing: 1px;\n}\n.settings-header .btn-icon {\n    background: var(--background-modifier-border);\n    color: var(--text-muted);\n}\n\n.settings-group {\n    margin-bottom: 1.5rem;\n    text-align: left;\n}\n.settings-group label {\n    display: block;\n    font-size: 0.75rem;\n    font-weight: 800;\n    color: var(--text-muted);\n    text-transform: uppercase;\n    margin-bottom: 10px;\n}\n\n.input-row {\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    gap: 8px;\n}\n\n.input-field {\n    display: flex;\n    flex-direction: column;\n    gap: 4px;\n}\n.input-field span {\n    font-size: 0.65rem;\n    font-weight: 700;\n    color: var(--text-faint);\n}\n.input-field input {\n    width: 100%;\n    background: var(--background-secondary);\n    border: 1px solid var(--background-modifier-border);\n    color: var(--text-normal);\n    padding: 8px;\n    border-radius: 8px;\n    font-size: 0.9rem;\n    font-weight: 700;\n    text-align: center;\n}\n\n.toggle-row {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.btn-save {\n    width: 100%;\n    background: #ba4949;\n    color: white;\n    border: none;\n    padding: 12px;\n    border-radius: 12px;\n    font-weight: 800;\n    cursor: pointer;\n    transition: all 0.2s;\n}\n.btn-save:hover { opacity: 0.9; }\n\n/* Switch Toggle */\n.switch {\n  position: relative;\n  display: inline-block;\n  width: 40px;\n  height: 20px;\n}\n.switch input { opacity: 0; width: 0; height: 0; }\n.slider {\n  position: absolute;\n  cursor: pointer;\n  top: 0; left: 0; right: 0; bottom: 0;\n  background-color: var(--background-modifier-border);\n  transition: .4s; border-radius: 20px;\n}\n.slider:before {\n  position: absolute;\n  content: \"\";\n  height: 14px; width: 14px;\n  left: 3px; bottom: 3px;\n  background-color: white;\n  transition: .4s; border-radius: 50%;\n}\ninput:checked + .slider { background-color: #ba4949; }\ninput:checked + .slider:before { transform: translateX(20px); }",
  "js": "const { root, saveState, getState } = api;\n\nlet state = {\n    timeLeft: 1500,\n    sessions: 0,\n    currentMode: 'pomo',\n    pomoTime: 25,\n    shortTime: 5,\n    longTime: 15,\n    soundEnabled: true,\n    autoPiP: false\n};\n\nlet timerId = null;\nlet pipVideo = null;\nlet pipCanvas = null;\nlet silentAudio = null;\n\nconst MODES = {\n    pomo: { label: 'Pomodoro', color: '#ba4949' },\n    short: { label: 'Short Break', color: '#38858a' },\n    long: { label: 'Long Break', color: '#397097' }\n};\n\nfunction playSound() {\n    if (!state.soundEnabled) return;\n    try {\n        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();\n        const oscillator = audioCtx.createOscillator();\n        const gainNode = audioCtx.createGain();\n        oscillator.type = 'sine';\n        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);\n        oscillator.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.5);\n        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);\n        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);\n        oscillator.connect(gainNode);\n        gainNode.connect(audioCtx.destination);\n        oscillator.start();\n        oscillator.stop(audioCtx.currentTime + 0.5);\n    } catch (e) { console.error('Audio error:', e); }\n}\n\nfunction updateMediaSession() {\n    if (!('mediaSession' in navigator)) return;\n\n    const mins = Math.floor(state.timeLeft / 60);\n    const secs = state.timeLeft % 60;\n    const timeStr = `${mins}:${secs < 10 ? '0' : ''}${secs}`;\n\n    navigator.mediaSession.metadata = new MediaMetadata({\n        title: `${MODES[state.currentMode].label} (${timeStr})`,\n        artist: 'Pomodoro Timer Pro',\n        album: 'Obsidget Gallery',\n        artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/3663/3663335.png', sizes: '512x512', type: 'image/png' }]\n    });\n\n    navigator.mediaSession.playbackState = timerId ? 'playing' : 'paused';\n}\n\nasync function nudgePiP() {\n    // If paused in PiP, briefly play/pause to force a frame refresh\n    if (pipVideo && pipVideo.paused && document.pictureInPictureElement === pipVideo) {\n        try {\n            await pipVideo.play();\n            pipVideo.pause();\n        } catch (e) {}\n    }\n}\n\nfunction updatePiP() {\n    if (!pipCanvas) return;\n    const ctx = pipCanvas.getContext('2d');\n    const mins = Math.floor(state.timeLeft / 60);\n    const secs = state.timeLeft % 60;\n    const timeStr = `${mins}:${secs < 10 ? '0' : ''}${secs}`;\n    \n    ctx.fillStyle = MODES[state.currentMode].color;\n    ctx.fillRect(0, 0, pipCanvas.width, pipCanvas.height);\n    \n    ctx.fillStyle = 'white';\n    ctx.font = 'bold 80px monospace';\n    ctx.textAlign = 'center';\n    ctx.textBaseline = 'middle';\n    ctx.fillText(timeStr, pipCanvas.width / 2, pipCanvas.height / 2 + 5);\n    \n    ctx.font = 'bold 20px sans-serif';\n    ctx.fillText(MODES[state.currentMode].label.toUpperCase(), pipCanvas.width / 2, 25);\n    \n    updateMediaSession();\n    nudgePiP(); // Force refresh if paused\n}\n\nasync function enterPiP() {\n    if (document.pictureInPictureElement) return;\n    try {\n        if (!pipVideo.srcObject) {\n            const stream = pipCanvas.captureStream(10);\n            pipVideo.srcObject = stream;\n        }\n        await pipVideo.play();\n        await pipVideo.requestPictureInPicture();\n        if (silentAudio) silentAudio.play();\n        if (!timerId) pipVideo.pause(); // Stay paused if timer is not running\n    } catch (e) { console.error('PiP enter error:', e); }\n}\n\nasync function exitPiP() {\n    if (document.pictureInPictureElement === pipVideo) {\n        try { \n            await document.exitPictureInPicture(); \n            if (silentAudio) silentAudio.pause();\n        } catch (e) { console.error('PiP exit error:', e); }\n    }\n}\n\nasync function togglePiP() {\n    if (document.pictureInPictureElement) {\n        await exitPiP();\n    } else {\n        await enterPiP();\n    }\n}\n\nfunction updateDisplay() {\n    const mins = Math.floor(state.timeLeft / 60);\n    const secs = state.timeLeft % 60;\n    root.getElementById('timer-display').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;\n    updatePiP();\n}\n\nfunction setMode(mode) {\n    state.currentMode = mode;\n    const duration = state[`${mode}Time`] * 60;\n    state.timeLeft = duration;\n    \n    const card = root.getElementById('pomo-card');\n    root.querySelectorAll('.mode-btn').forEach(btn => {\n        btn.classList.toggle('active', btn.id === `mode-${mode}`);\n    });\n    \n    card.style.background = MODES[mode].color;\n    \n    resetTimer();\n    updatePiP();\n}\n\nfunction nextMode() {\n    const modes = ['pomo', 'short', 'long'];\n    const idx = modes.indexOf(state.currentMode);\n    setMode(modes[(idx + 1) % modes.length]);\n}\n\nfunction prevMode() {\n    const modes = ['pomo', 'short', 'long'];\n    const idx = modes.indexOf(state.currentMode);\n    setMode(modes[(idx - 1 + modes.length) % modes.length]);\n}\n\nfunction toggleTimer() {\n    const startBtn = root.getElementById('start-btn');\n    if (timerId) {\n        clearInterval(timerId);\n        timerId = null;\n        startBtn.innerText = 'START';\n        if (silentAudio) silentAudio.pause();\n        if (pipVideo) pipVideo.pause();\n        if (state.autoPiP) exitPiP();\n        if ('mediaSession' in navigator) {\n            navigator.mediaSession.playbackState = 'paused';\n        }\n    } else {\n        startBtn.innerText = 'PAUSE';\n        if (silentAudio) silentAudio.play();\n        if (pipVideo) pipVideo.play();\n        if (state.autoPiP) enterPiP();\n        if ('mediaSession' in navigator) {\n            navigator.mediaSession.playbackState = 'playing';\n        }\n        timerId = setInterval(() => {\n            state.timeLeft--;\n            updateDisplay();\n            if (state.timeLeft <= 0) {\n                clearInterval(timerId);\n                timerId = null;\n                startBtn.innerText = 'START';\n                playSound();\n                if (silentAudio) silentAudio.pause();\n                if (pipVideo) pipVideo.pause();\n                if (state.autoPiP) exitPiP();\n                if ('mediaSession' in navigator) {\n                    navigator.mediaSession.playbackState = 'paused';\n                }\n                if (state.currentMode === 'pomo') {\n                    state.sessions++;\n                    root.getElementById('session-count').innerText = state.sessions;\n                }\n                saveState(state);\n            }\n        }, 1000);\n    }\n    updateMediaSession();\n}\n\nfunction resetTimer() {\n    if (timerId) {\n        clearInterval(timerId);\n        timerId = null;\n    }\n    state.timeLeft = state[`${state.currentMode}Time`] * 60;\n    root.getElementById('start-btn').innerText = 'START';\n    if (silentAudio) silentAudio.pause();\n    if (pipVideo) pipVideo.pause();\n    if (state.autoPiP) exitPiP();\n    updateDisplay();\n    updateMediaSession();\n}\n\nfunction clearSessions() {\n    state.sessions = 0;\n    root.getElementById('session-count').innerText = 0;\n    saveState(state);\n}\n\nfunction openSettings() {\n    root.getElementById('input-pomo').value = state.pomoTime;\n    root.getElementById('input-short').value = state.shortTime;\n    root.getElementById('input-long').value = state.longTime;\n    root.getElementById('toggle-sound').checked = state.soundEnabled;\n    root.getElementById('toggle-autopip').checked = state.autoPiP;\n    root.getElementById('settings-overlay').classList.add('show');\n}\n\nfunction closeSettings() {\n    root.getElementById('settings-overlay').classList.remove('show');\n}\n\nfunction saveSettings() {\n    state.pomoTime = parseInt(root.getElementById('input-pomo').value) || 25;\n    state.shortTime = parseInt(root.getElementById('input-short').value) || 5;\n    state.longTime = parseInt(root.getElementById('input-long').value) || 15;\n    state.soundEnabled = root.getElementById('toggle-sound').checked;\n    state.autoPiP = root.getElementById('toggle-autopip').checked;\n    \n    closeSettings();\n    resetTimer();\n    saveState(state);\n}\n\nasync function init() {\n    pipCanvas = root.getElementById('pip-canvas');\n    pipVideo = root.getElementById('pip-video');\n    silentAudio = root.getElementById('silent-audio');\n\n    root.getElementById('mode-pomo').onclick = () => setMode('pomo');\n    root.getElementById('mode-short').onclick = () => setMode('short');\n    root.getElementById('mode-long').onclick = () => setMode('long');\n    root.getElementById('start-btn').onclick = toggleTimer;\n    root.getElementById('reset-btn').onclick = resetTimer;\n    root.getElementById('btn-clear').onclick = clearSessions;\n    root.getElementById('btn-settings').onclick = openSettings;\n    root.getElementById('btn-close-settings').onclick = closeSettings;\n    root.getElementById('btn-save-settings').onclick = saveSettings;\n    root.getElementById('btn-pip').onclick = togglePiP;\n\n    try {\n        const saved = await getState();\n        if (saved) {\n             Object.assign(state, saved);\n             root.getElementById('session-count').innerText = state.sessions;\n        }\n    } catch(e) { console.error('API Error', e); }\n\n    if ('mediaSession' in navigator) {\n        navigator.mediaSession.setActionHandler('play', toggleTimer);\n        navigator.mediaSession.setActionHandler('pause', toggleTimer);\n        navigator.mediaSession.setActionHandler('nexttrack', nextMode);\n        navigator.mediaSession.setActionHandler('previoustrack', prevMode);\n    }\n\n    setMode(state.currentMode);\n    updateDisplay();\n}\n\ninit();",
  "tags": [
    "productivity",
    "time",
    "focus",
    "premium",
    "pip",
    "autopip",
    "mediasession"
  ]
}