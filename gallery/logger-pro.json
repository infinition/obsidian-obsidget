{
    "id": "logger-pro",
    "name": "Logger Pro",
    "description": "The ultimate logger: Inline table editing, resizable UI, and smart schema presets. Syncs seamlessly with CSV files, Note YAML (with global vault autocomplete), or internal JSON storage.",
    "author": "Infinition",
    "createdDate": 1768819178000,
    "lastModifiedDate": 1768819178000,
    "html": "<div class=\"logger-wrapper\" id=\"logger-root\"><div class=\"logger-header\"><div class=\"logger-title-group\"><svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\"></path><polyline points=\"14 2 14 8 20 8\"></polyline></svg><span class=\"logger-title\">LOGGER PRO</span><button class=\"logger-icon-btn\" id=\"logger-switch-mode-btn\" title=\"Switch Storage Mode\"><svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polyline points=\"23 4 23 10 17 10\"></polyline><polyline points=\"1 20 1 14 7 14\"></polyline><path d=\"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15\"></path></svg></button><button class=\"logger-icon-btn\" id=\"logger-settings-btn\" title=\"Settings\"><svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"3\"></circle><path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z\"></path></svg></button></div><div class=\"logger-actions\"><button class=\"logger-icon-btn\" id=\"logger-export-btn\" title=\"Export to CSV\"><svg viewBox=\"0 0 24 24\" width=\"14\" height=\"14\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"></path><polyline points=\"7 10 12 15 17 10\"></polyline><line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"></line></svg></button></div></div><div class=\"logger-storage-config\" id=\"yaml-config-panel\"><div class=\"config-row\"><div class=\"config-item\"><label>Target Note</label><input type=\"text\" id=\"main-yaml-path\" placeholder=\"Current note\" list=\"vault-md-list\"><datalist id=\"vault-md-list\"></datalist></div><div class=\"config-item\"><label>YAML Property</label><input type=\"text\" id=\"main-yaml-key\" placeholder=\"logs\" list=\"vault-key-list\"><datalist id=\"vault-key-list\"></datalist></div></div></div><div class=\"logger-storage-config\" id=\"csv-config-panel\"><div class=\"config-row\"><div class=\"config-item\"><label>CSV File Path</label><input type=\"text\" id=\"main-csv-path\" placeholder=\"Path/to/file.csv\" list=\"vault-csv-list\"><datalist id=\"vault-csv-list\"></datalist></div></div></div><div class=\"logger-input-panel\" id=\"input-panel\"></div><div class=\"logger-list-container\"><div class=\"logger-list-header\"><div class=\"logger-list-title\"><span id=\"storage-indicator\" class=\"storage-badge\">Instance</span></div><div class=\"logger-search-box\"><svg viewBox=\"0 0 24 24\" width=\"12\" height=\"12\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"11\" cy=\"11\" r=\"8\"></circle><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"></line></svg><input type=\"text\" id=\"logger-search-input\" placeholder=\"Search...\"></div></div><div class=\"logger-table-header\" id=\"table-header\"></div><div id=\"logger-entries\" class=\"logger-entries\"></div></div><div class=\"logger-settings-panel\" id=\"logger-settings-modal\"><div class=\"settings-header\"><span>SETTINGS</span><button id=\"btn-close-settings-x\">X</button></div><div class=\"settings-body\"><div class=\"setting-group\"><label>Storage Mode</label><select id=\"setting-storage-mode\"><option value=\"instance\">Instance (JSON)</option><option value=\"csv\">Vault File (CSV)</option><option value=\"yaml\">Note YAML</option></select></div><div class=\"setting-group\"><label>CSV Delimiter</label><select id=\"setting-csv-delimiter\"><option value=\",\">Comma (,)</option><option value=\";\">Semicolon (;)</option></select></div><div class=\"setting-group\"><label>Custom Fields</label><button class=\"accent-btn\" id=\"btn-edit-schema\">Edit Schema</button></div><div class=\"setting-actions\"><button class=\"danger-btn\" id=\"btn-remove-dupes\">Clean Dupes</button><button class=\"danger-btn\" id=\"btn-clear-data\">Clear All</button></div></div></div><div class=\"logger-settings-panel\" id=\"schema-modal\"><div class=\"settings-header\"><span>EDIT SCHEMA</span><button id=\"btn-close-schema-x\">X</button></div><div class=\"settings-body\"><label class=\"schema-label\">Quick Presets (Click to add)</label><div id=\"schema-presets\" class=\"schema-presets-container\"></div><label class=\"schema-label\" style=\"margin-top:10px;\">Current Fields</label><div id=\"schema-list\"></div><button class=\"accent-btn\" id=\"btn-add-field\">+ Add Custom Field</button><div class=\"setting-actions\" style=\"margin-top:20px;\"><button class=\"accent-btn\" id=\"btn-save-schema\">Save Schema</button><button id=\"btn-cancel-schema\">Cancel</button></div></div></div></div>",
    "css": ":host{--logger-bg:var(--background-secondary);--logger-card:var(--background-primary);--logger-accent:var(--interactive-accent);--logger-border:var(--background-modifier-border);--logger-text:var(--text-normal);--logger-muted:var(--text-muted);--logger-radius:8px}.logger-wrapper{width:100%;padding:12px;font-family:var(--font-interface);color:var(--logger-text);box-sizing:border-box;background:var(--logger-bg);border-radius:var(--logger-radius);border:1px solid var(--logger-border);position:relative;display:flex;flex-direction:column;gap:10px;overflow:hidden;min-height:250px;resize:vertical}.logger-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:8px;border-bottom:1px solid var(--logger-border)}.logger-title-group{display:flex;align-items:center;gap:8px}.logger-title{font-weight:700;font-size:.75rem;color:var(--logger-muted);letter-spacing:.8px}.logger-icon-btn{background:none;border:none;color:var(--logger-muted);cursor:pointer;padding:4px;border-radius:4px;display:flex;transition:all .2s}.logger-icon-btn:hover{background:var(--background-modifier-hover);color:var(--logger-text)}#logger-switch-mode-btn:hover{color:var(--logger-accent)}#logger-switch-mode-btn svg{transition:transform .3s ease}#logger-switch-mode-btn:active svg{transform:rotate(180deg)}.logger-storage-config{background:var(--background-primary-alt);padding:10px;border-radius:6px;border:1px solid var(--logger-border);display:none}.config-row{display:flex;gap:10px}.config-item{flex:1;display:flex;flex-direction:column;gap:4px}.config-item label{font-size:.65rem;font-weight:700;color:var(--logger-muted);text-transform:uppercase}.config-item input{background:var(--logger-card);border:1px solid var(--logger-border);color:var(--logger-text);padding:6px 10px;border-radius:4px;font-size:.8rem;width:100%;box-sizing:border-box}.logger-input-panel{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end}.logger-input-panel input,.logger-input-panel select{flex:1;min-width:80px;background:var(--logger-card);border:1px solid var(--logger-border);color:var(--logger-text);padding:6px 10px;border-radius:4px;font-size:.85rem}.logger-input-panel input[type=checkbox]{flex:none;width:18px;height:18px}#log-submit-btn{background:var(--logger-accent);color:#fff;border:none;padding:6px 16px;border-radius:4px;cursor:pointer;font-weight:600;font-size:.8rem;flex-shrink:0}.logger-list-container{background:var(--logger-card);border-radius:6px;border:1px solid var(--logger-border);overflow:hidden;display:flex;flex-direction:column;flex:1}.logger-list-header{padding:8px 12px;background:var(--background-secondary-alt);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--logger-border);gap:10px}.storage-badge{font-size:.65rem;padding:2px 6px;border-radius:4px;background:var(--logger-accent);color:#fff;font-weight:700}.logger-search-box{display:flex;align-items:center;background:var(--background-primary);border:1px solid var(--logger-border);border-radius:4px;padding:2px 8px;gap:6px;flex:1;max-width:140px}.logger-search-box input{background:none;border:none;color:var(--logger-text);font-size:.75rem;width:100%;outline:none}.logger-table-header{display:flex;align-items:center;padding:6px 12px;background:var(--background-primary-alt);border-bottom:1px solid var(--logger-border);font-size:.7rem;font-weight:700;color:var(--logger-muted);text-transform:uppercase;gap:10px;user-select:none}.logger-table-header>span{cursor:pointer;display:flex;align-items:center;gap:4px;transition:color .2s;min-width:50px;flex:1}.logger-table-header>span:hover{color:var(--logger-accent)}.logger-table-header>span.active{color:var(--logger-accent)}.th-action{width:20px;flex:none!important;min-width:20px!important}.sort-arrow{font-size:.6rem;opacity:.5}.active .sort-arrow{opacity:1}.logger-entries{max-height:100%;overflow-y:auto;flex:1}.logger-entry{display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid var(--logger-border);font-size:.8rem;gap:10px}.logger-entry:last-child{border-bottom:none}.logger-entry>span{flex:1;min-width:50px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;border:1px solid transparent;border-radius:4px;padding:2px 4px}.logger-entry>span:first-child{color:var(--logger-muted);font-size:.7rem;cursor:default}.logger-entry>span:not(:first-child):hover{border-color:var(--logger-border);background:var(--background-modifier-hover)}.entry-delete{opacity:0;cursor:pointer;color:var(--text-error);font-size:.9rem;padding:2px;width:20px;flex:none!important;min-width:20px!important;text-align:center}.logger-entry:hover .entry-delete{opacity:1}.logger-settings-panel{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--logger-bg);display:none;z-index:100;border-radius:var(--logger-radius);flex-direction:column;overflow:hidden}.settings-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;font-weight:800;font-size:.85rem;color:var(--logger-accent);letter-spacing:1px;border-bottom:1px solid var(--logger-border);background:var(--background-primary-alt)}.settings-header button{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;padding:4px 8px;border-radius:4px}.settings-header button:hover{background:var(--background-modifier-hover);color:var(--text-normal)}.settings-body{padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:14px;flex:1}.setting-group{display:flex;flex-direction:column;gap:6px}.setting-group label{font-size:.7rem;font-weight:700;color:var(--logger-muted);text-transform:uppercase}.setting-group select,.setting-group input{background:var(--background-primary);border:1px solid var(--logger-border);color:var(--text-normal);padding:8px 12px;border-radius:6px;font-size:.85rem;width:100%;box-sizing:border-box}.setting-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}.setting-actions button{padding:8px;border-radius:6px;font-size:.75rem;cursor:pointer;border:1px solid var(--logger-border);background:var(--interactive-normal);font-weight:700;color:var(--text-normal)}.accent-btn{background:var(--logger-accent)!important;color:#fff!important;border-color:var(--logger-accent)!important}.danger-btn{color:var(--text-error)!important;border-color:var(--text-error)!important}.schema-field{display:flex;gap:6px;align-items:center;padding:6px;background:var(--background-primary);border-radius:6px;margin-bottom:6px}.schema-field input,.schema-field select{flex:1;padding:5px 8px;border:1px solid var(--logger-border);border-radius:4px;background:var(--background-secondary);color:var(--text-normal);font-size:.75rem}.schema-field .btn-remove-field{background:none;border:none;color:var(--text-error);cursor:pointer;font-size:.9rem;padding:4px}.link-tag{color:var(--text-accent);cursor:pointer;text-decoration:none}.link-tag:hover{text-decoration:underline}.schema-presets-container{display:flex;flex-wrap:wrap;gap:6px}.preset-tag{font-size:.7rem;background:var(--background-secondary-alt);border:1px solid var(--logger-border);padding:4px 8px;border-radius:12px;cursor:pointer;transition:all .2s;color:var(--text-muted);font-weight:600}.preset-tag:hover{border-color:var(--logger-accent);color:var(--logger-accent);background:var(--background-primary)}.cell-edit-input{width:100%;height:100%;border:none;background:var(--background-primary);color:var(--text-normal);font-family:inherit;font-size:inherit;padding:0;outline:none;border-bottom:1px solid var(--logger-accent)}.schema-label{font-size:.7rem;font-weight:700;color:var(--logger-muted);text-transform:uppercase;display:block}",
    "js": "(function(){var root=api.root;var app=window.app||api.app;var storageModes=['instance','csv','yaml'];var defaultSchema=[{key:'cat',label:'Category',type:'text',options:[]},{key:'val',label:'Value',type:'text',options:[]},{key:'note',label:'Note',type:'text',options:[]}];var presets=[{label:'Date',key:'date',type:'text',val:'{{date}}'},{label:'Time',key:'time',type:'text',val:'{{time}}'},{label:'Link [[ ]]',key:'link',type:'text',val:'[[ ]]'},{label:'Tag #',key:'tag',type:'text',val:'#'},{label:'Rating (1-5)',key:'rating',type:'select',options:['1','2','3','4','5']},{label:'Status',key:'status',type:'select',options:['Todo','Doing','Done']},{label:'Checkbox',key:'check',type:'checkbox'},{label:'Amount',key:'amount',type:'number'}];var state={entries:[],settings:{storageMode:'instance',csvPath:'Logs/logger.csv',yamlPath:'',yamlKey:'logs',csvDelimiter:',',sortBy:'ts',sortDir:'desc',showLastN:30,isSettingsOpen:false,schema:null,height:null}};var instanceBuffer=[];var searchQuery='';var tempSchema=[];var focusBackup={};function clearOnFocus(el,key){if(!el)return;focusBackup[key]=el.value;el.value='';}function restoreOnBlur(el,key,settingKey){if(!el)return;if(el.value.trim()===''&&focusBackup[key]!==undefined){el.value=focusBackup[key];}else if(settingKey&&el.value.trim()!==''){state.settings[settingKey]=el.value.trim();save();}}function escapeHtml(t){if(!t)return'';var d=document.createElement('div');d.textContent=t;return d.innerHTML;}function formatCell(val){if(!val||typeof val!=='string')return escapeHtml(val)||'';var esc=escapeHtml(val);return esc.replace(/#([A-Za-z0-9_-]+)/g,function(m,tag){return'<span class=\"link-tag\" data-tag=\"'+tag+'\">#'+tag+'</span>';});}function searchTag(tag){try{if(app&&app.internalPlugins){var sp=app.internalPlugins.getPluginById('global-search');if(sp&&sp.instance)sp.instance.openGlobalSearch('tag:#'+tag);}}catch(e){}}api.getState().then(function(saved){if(saved){if(saved.instanceEntries)instanceBuffer=saved.instanceEntries;if(saved.settings){var s=saved.settings;if(s.storageMode)state.settings.storageMode=s.storageMode;if(s.csvPath)state.settings.csvPath=s.csvPath;if(s.yamlPath!==undefined)state.settings.yamlPath=s.yamlPath;if(s.yamlKey)state.settings.yamlKey=s.yamlKey;if(s.csvDelimiter)state.settings.csvDelimiter=s.csvDelimiter;if(s.sortBy)state.settings.sortBy=s.sortBy;if(s.sortDir)state.settings.sortDir=s.sortDir;if(s.showLastN)state.settings.showLastN=s.showLastN;if(s.isSettingsOpen!==undefined)state.settings.isSettingsOpen=s.isSettingsOpen;if(s.schema&&s.schema.length>0)state.settings.schema=s.schema;if(s.height)state.settings.height=s.height;}if(state.settings.storageMode==='instance'&&saved.entries){state.entries=saved.entries;}}if(!state.settings.schema||state.settings.schema.length===0){state.settings.schema=JSON.parse(JSON.stringify(defaultSchema));}if(state.settings.height){var wrap=root.getElementById('logger-root');if(wrap)wrap.style.height=state.settings.height;}buildInputPanel();buildTableHeader();setupEvents();updateAllDatalists();if(state.settings.isSettingsOpen)showPanel('logger-settings-modal');render();if(state.settings.storageMode==='yaml')refreshFromYAML();else if(state.settings.storageMode==='csv')refreshFromCSV();}).catch(function(e){console.error('Init error:',e);state.settings.schema=JSON.parse(JSON.stringify(defaultSchema));buildInputPanel();buildTableHeader();setupEvents();render();});function showPanel(id){var p=root.getElementById(id);if(p)p.style.display='flex';}function hidePanel(id){var p=root.getElementById(id);if(p)p.style.display='none';}function updateAllDatalists(){updateVaultFilesDatalist();updateYAMLKeysDatalist();updateFieldDatalistsFromEntries();}function updateVaultFilesDatalist(){if(!app||!app.vault)return;try{var mdList=root.getElementById('vault-md-list');var csvList=root.getElementById('vault-csv-list');var allFiles=app.vault.getFiles();if(mdList){var mdFiles=allFiles.filter(function(f){return f.path.endsWith('.md');});mdList.innerHTML=mdFiles.slice(0,200).map(function(f){return'<option value=\"'+f.path+'\">';}).join('');}if(csvList){var csvFiles=allFiles.filter(function(f){return f.path.endsWith('.csv');});var paths=csvFiles.map(function(f){return f.path;});if(state.settings.csvPath&&paths.indexOf(state.settings.csvPath)===-1)paths.unshift(state.settings.csvPath);csvList.innerHTML=paths.slice(0,100).map(function(p){return'<option value=\"'+p+'\">';}).join('');}}catch(e){}}function updateYAMLKeysDatalist(){var keyList=root.getElementById('vault-key-list');if(!keyList)return;var targetPath=state.settings.yamlPath||undefined;api.getFrontmatter(targetPath).then(function(fm){var currentKeys=fm?Object.keys(fm):[];var allKeys=[];if(app.metadataCache&&app.metadataCache.getAllPropertyInfos){var infos=app.metadataCache.getAllPropertyInfos();allKeys=Object.keys(infos);}var others=allKeys.filter(function(k){return currentKeys.indexOf(k)===-1;});var combined=currentKeys.concat(others);keyList.innerHTML=combined.map(function(k){return'<option value=\"'+k+'\">';}).join('');}).catch(function(e){});}function updateFieldDatalistsFromEntries(){var schema=state.settings.schema||defaultSchema;for(var i=0;i<schema.length;i++){var f=schema[i];if(f.type==='text'){var dlId='dl-'+f.key;var dl=root.getElementById(dlId);if(dl){var valSet={};for(var j=0;j<state.entries.length;j++){var v=state.entries[j][f.key];if(v&&v.toString().trim())valSet[v.toString().trim()]=true;}var opts=Object.keys(valSet).slice(0,50);dl.innerHTML=opts.map(function(o){return'<option value=\"'+o+'\">';}).join('');}}}}function updateSchemaFromKeys(keys){var newSchema=[];keys.forEach(function(k){if(k==='id')return;newSchema.push({key:k,label:k.charAt(0).toUpperCase()+k.slice(1),type:'text',options:[]});});state.settings.schema=newSchema;buildInputPanel();buildTableHeader();}function buildInputPanel(){var panel=root.getElementById('input-panel');if(!panel)return;var html='';var schema=state.settings.schema||defaultSchema;for(var i=0;i<schema.length;i++){var f=schema[i];if(f.type==='select'&&f.options&&f.options.length){html+='<select id=\"input-'+f.key+'\"><option value=\"\">'+f.label+'</option>';for(var j=0;j<f.options.length;j++)html+='<option value=\"'+f.options[j]+'\">'+f.options[j]+'</option>';html+='</select>';}else if(f.type==='checkbox'){html+='<label style=\"display:flex;align-items:center;gap:4px\"><input type=\"checkbox\" id=\"input-'+f.key+'\"> '+f.label+'</label>';}else if(f.type==='number'){html+='<input type=\"number\" id=\"input-'+f.key+'\" placeholder=\"'+f.label+'\">';}else{var ph=f.label;if(f.key==='date')ph='YYYY-MM-DD';if(f.key==='time')ph='HH:MM';html+='<input type=\"text\" id=\"input-'+f.key+'\" placeholder=\"'+ph+'\" list=\"dl-'+f.key+'\" class=\"has-datalist\">';html+='<datalist id=\"dl-'+f.key+'\"></datalist>';}}html+='<button id=\"log-submit-btn\">Log</button>';panel.innerHTML=html;var inputs=panel.querySelectorAll('.has-datalist');for(var k=0;k<inputs.length;k++){(function(inp){var key=inp.id.replace('input-','');inp.onfocus=function(){clearOnFocus(inp,key);updateFieldDatalistsFromEntries();};inp.onblur=function(){restoreOnBlur(inp,key,null);};})(inputs[k]);}}function buildTableHeader(){var header=root.getElementById('table-header');if(!header)return;var html='';var schema=state.settings.schema||defaultSchema;for(var i=0;i<schema.length;i++)html+='<span data-sort=\"'+schema[i].key+'\">'+schema[i].label+' <span class=\"sort-arrow\"></span></span>';html+='<span class=\"th-action\"></span>';header.innerHTML=html;setupSortHeaders();}function setupSortHeaders(){var ths=root.querySelectorAll('#table-header > span[data-sort]');for(var i=0;i<ths.length;i++){(function(th){th.onclick=function(){var col=th.getAttribute('data-sort');if(state.settings.sortBy===col)state.settings.sortDir=state.settings.sortDir==='asc'?'desc':'asc';else{state.settings.sortBy=col;state.settings.sortDir='asc';}render();save();};})(ths[i]);}}function setupEvents(){var wrap=root.getElementById('logger-root');if(wrap){wrap.onmouseup=function(){state.settings.height=wrap.style.height;save();};}var switchBtn=root.getElementById('logger-switch-mode-btn');if(switchBtn)switchBtn.onclick=function(){var idx=storageModes.indexOf(state.settings.storageMode);var prevMode=state.settings.storageMode;var newMode=storageModes[(idx+1)%3];if(prevMode==='instance'){instanceBuffer=JSON.parse(JSON.stringify(state.entries));}state.settings.storageMode=newMode;if(newMode==='instance'){state.entries=JSON.parse(JSON.stringify(instanceBuffer));state.settings.schema=JSON.parse(JSON.stringify(defaultSchema));buildInputPanel();buildTableHeader();}else{state.entries=[];}save();render();updateAllDatalists();if(newMode==='yaml')refreshFromYAML();if(newMode==='csv')refreshFromCSV();new Notice('Mode: '+newMode.toUpperCase());};var settingsBtn=root.getElementById('logger-settings-btn');if(settingsBtn)settingsBtn.onclick=function(){state.settings.isSettingsOpen=true;showPanel('logger-settings-modal');updateVaultFilesDatalist();save();};var closeSettings=root.getElementById('btn-close-settings-x');if(closeSettings)closeSettings.onclick=function(){state.settings.isSettingsOpen=false;hidePanel('logger-settings-modal');save();};var exportBtn=root.getElementById('logger-export-btn');if(exportBtn)exportBtn.onclick=exportToCSV;var searchInput=root.getElementById('logger-search-input');if(searchInput)searchInput.oninput=function(e){searchQuery=e.target.value.toLowerCase();render();};var yamlPath=root.getElementById('main-yaml-path');if(yamlPath){yamlPath.onfocus=function(){clearOnFocus(yamlPath,'yamlPath');updateVaultFilesDatalist();};yamlPath.onblur=function(){restoreOnBlur(yamlPath,'yamlPath','yamlPath');updateYAMLKeysDatalist();refreshFromYAML();};}var yamlKey=root.getElementById('main-yaml-key');if(yamlKey){yamlKey.onfocus=function(){clearOnFocus(yamlKey,'yamlKey');updateYAMLKeysDatalist();};yamlKey.onblur=function(){restoreOnBlur(yamlKey,'yamlKey','yamlKey');refreshFromYAML();};}var modeSelect=root.getElementById('setting-storage-mode');if(modeSelect)modeSelect.onchange=function(e){var newMode=e.target.value;if(state.settings.storageMode==='instance'){instanceBuffer=JSON.parse(JSON.stringify(state.entries));}state.settings.storageMode=newMode;if(newMode==='instance'){state.entries=JSON.parse(JSON.stringify(instanceBuffer));state.settings.schema=JSON.parse(JSON.stringify(defaultSchema));buildInputPanel();buildTableHeader();}else{state.entries=[];}save();render();updateAllDatalists();if(newMode==='yaml')refreshFromYAML();if(newMode==='csv')refreshFromCSV();};var csvPath=root.getElementById('main-csv-path');if(csvPath){csvPath.oninput=function(e){var val=e.target.value.trim();if(val){var file=app.vault.getAbstractFileByPath(val);if(file){state.settings.csvPath=val;save();refreshFromCSV();}}};csvPath.onfocus=function(){clearOnFocus(csvPath,'csvPath');updateVaultFilesDatalist();};csvPath.onblur=function(){restoreOnBlur(csvPath,'csvPath','csvPath');refreshFromCSV();};}var csvDelim=root.getElementById('setting-csv-delimiter');if(csvDelim)csvDelim.onchange=function(e){state.settings.csvDelimiter=e.target.value;save();refreshFromCSV();};var clearBtn=root.getElementById('btn-clear-data');if(clearBtn)clearBtn.onclick=function(){if(confirm('Clear all entries?')){state.entries=[];render();save().then(function(){updateFieldDatalistsFromEntries();syncToExternal();});}};var dupesBtn=root.getElementById('btn-remove-dupes');if(dupesBtn)dupesBtn.onclick=function(){var seen={};state.entries=state.entries.filter(function(e){var k=JSON.stringify(e);if(seen[k])return false;seen[k]=true;return true;});render();save().then(function(){updateFieldDatalistsFromEntries();syncToExternal();});};var editSchema=root.getElementById('btn-edit-schema');if(editSchema)editSchema.onclick=function(){tempSchema=JSON.parse(JSON.stringify(state.settings.schema||defaultSchema));renderSchemaEditor();hidePanel('logger-settings-modal');showPanel('schema-modal');};var closeSchema=root.getElementById('btn-close-schema-x');if(closeSchema)closeSchema.onclick=function(){hidePanel('schema-modal');};var cancelSchema=root.getElementById('btn-cancel-schema');if(cancelSchema)cancelSchema.onclick=function(){hidePanel('schema-modal');};var addField=root.getElementById('btn-add-field');if(addField)addField.onclick=function(){tempSchema.push({key:'field'+Date.now(),label:'New Field',type:'text',options:[]});renderSchemaEditor();};var saveSchema=root.getElementById('btn-save-schema');if(saveSchema)saveSchema.onclick=function(){readSchemaFromEditor();state.settings.schema=tempSchema;buildInputPanel();buildTableHeader();updateFieldDatalistsFromEntries();hidePanel('schema-modal');save();render();};var inputPanel=root.getElementById('input-panel');if(inputPanel){inputPanel.onclick=function(e){if(e.target&&e.target.id==='log-submit-btn')addEntry();};inputPanel.onkeydown=function(e){if(e.key==='Enter'&&e.target.tagName==='INPUT')addEntry();};}}function renderSchemaEditor(){var list=root.getElementById('schema-list');if(!list)return;var html='';for(var i=0;i<tempSchema.length;i++){var f=tempSchema[i];html+='<div class=\"schema-field\" data-index=\"'+i+'\"><input type=\"text\" class=\"field-key\" value=\"'+f.key+'\" placeholder=\"Key\"><input type=\"text\" class=\"field-label\" value=\"'+f.label+'\" placeholder=\"Label\"><select class=\"field-type\"><option value=\"text\"'+(f.type==='text'?' selected':'')+'>Text</option><option value=\"number\"'+(f.type==='number'?' selected':'')+'>Number</option><option value=\"select\"'+(f.type==='select'?' selected':'')+'>Select</option><option value=\"checkbox\"'+(f.type==='checkbox'?' selected':'')+'>Checkbox</option></select><input type=\"text\" class=\"field-options\" value=\"'+(f.options||[]).join(',')+'\" placeholder=\"Options\"><button class=\"btn-remove-field\" data-index=\"'+i+'\">X</button></div>';}list.innerHTML=html;var btns=list.querySelectorAll('.btn-remove-field');for(var j=0;j<btns.length;j++){(function(btn){btn.onclick=function(){tempSchema.splice(parseInt(btn.getAttribute('data-index')),1);renderSchemaEditor();};})(btns[j]);}renderSchemaPresets();}function renderSchemaPresets(){var cont=root.getElementById('schema-presets');if(!cont)return;cont.innerHTML='';presets.forEach(function(p){var tag=document.createElement('span');tag.className='preset-tag';tag.innerText='+ '+p.label;tag.onclick=function(){var newField={key:p.key+'_'+Date.now().toString().slice(-4),label:p.label,type:p.type,options:p.options||[]};tempSchema.push(newField);renderSchemaEditor();};cont.appendChild(tag);});}function readSchemaFromEditor(){var fields=root.querySelectorAll('.schema-field');tempSchema=[];for(var i=0;i<fields.length;i++){var el=fields[i];var key=el.querySelector('.field-key').value.trim()||'field';var label=el.querySelector('.field-label').value.trim()||'Field';var type=el.querySelector('.field-type').value;var optStr=el.querySelector('.field-options').value.trim();var options=optStr?optStr.split(',').map(function(o){return o.trim();}):[];tempSchema.push({key:key,label:label,type:type,options:options});}}function addEntry(){var entry={};entry.id=Date.now();entry.ts=new Date().toISOString();var schema=state.settings.schema||defaultSchema;for(var i=0;i<schema.length;i++){var f=schema[i];var el=root.getElementById('input-'+f.key);if(!el)continue;if(f.type==='checkbox')entry[f.key]=el.checked;else{var val=el.value.trim();if(f.key==='date'&&!val)val=new Date().toISOString().split('T')[0];if(f.key==='time'&&!val)val=new Date().toTimeString().split(' ')[0].slice(0,5);entry[f.key]=val;}}state.entries.unshift(entry);for(var j=0;j<schema.length;j++){var f2=schema[j];var el2=root.getElementById('input-'+f2.key);if(el2){if(f2.type==='checkbox')el2.checked=false;else el2.value='';}}render();updateFieldDatalistsFromEntries();save().then(function(){if(state.settings.storageMode==='yaml')setTimeout(function(){appendToYAML(entry);},100);if(state.settings.storageMode==='csv')setTimeout(function(){appendToCSV(entry);},100);});}function editCell(el,id,key,type,options){if(type==='checkbox'){var entry=state.entries.find(function(e){return e.id===id;});if(entry){entry[key]=!entry[key];render();save().then(function(){syncToExternal();});}return;}var currentVal=el.innerText;if(currentVal.indexOf('#')===0)currentVal=el.getAttribute('data-raw')||currentVal;el.innerHTML='';var input;if(type==='select'){input=document.createElement('select');options.forEach(function(o){var opt=document.createElement('option');opt.value=o;opt.innerText=o;if(o===currentVal)opt.selected=true;input.appendChild(opt);});}else{input=document.createElement('input');input.type=type==='number'?'number':'text';input.value=currentVal;}input.className='cell-edit-input';el.appendChild(input);input.focus();var saved=false;function finish(){if(saved)return;saved=true;var newVal=type==='select'?input.value:input.value.trim();var entry=state.entries.find(function(e){return e.id===id;});if(entry){entry[key]=newVal;render();save().then(function(){syncToExternal();});}else{render();}}input.onblur=finish;input.onkeydown=function(e){if(e.key==='Enter')finish();};}function appendToYAML(entry){var p=state.settings.yamlPath||undefined;api.getFrontmatter(p).then(function(fm){fm=fm||{};var k=state.settings.yamlKey||'logs';if(!Array.isArray(fm[k]))fm[k]=[];var obj={};obj.ts=entry.ts;var schema=state.settings.schema||defaultSchema;for(var i=0;i<schema.length;i++){var key=schema[i].key;if(entry[key]!==undefined)obj[key]=entry[key];}fm[k].push(obj);var upd={};upd[k]=fm[k];return api.updateFrontmatter(upd,p);}).then(function(){new Notice('YAML saved!');}).catch(function(e){console.error('YAML error:',e);new Notice('YAML Error: '+e.message);});}function appendToCSV(entry){var path=state.settings.csvPath;var d=state.settings.csvDelimiter;var schema=state.settings.schema||defaultSchema;api.readFile(path).then(function(content){content=content||'';var lines=content.split('\\n');var cols=[];if(lines.length>0&&lines[0].trim()){cols=lines[0].split(d).map(function(c){return c.replace(/^\"|\"$/g,'');});}else{cols=schema.map(function(s){return s.key;});}var vals=cols.map(function(c){return'\"'+(entry[c]||'').toString().replace(/\"/g,'\"\"')+'\"';}).join(d);var newContent=content;if(newContent&&!newContent.endsWith('\\n'))newContent+='\\n';newContent+=vals;return api.writeFile(path,newContent);}).then(function(){new Notice('CSV saved!');});}function syncToExternal(){if(state.settings.storageMode==='yaml'){var p=state.settings.yamlPath||undefined;var k=state.settings.yamlKey||'logs';var schema=state.settings.schema||defaultSchema;var entries=state.entries.slice().reverse().map(function(e){var obj={};obj.ts=e.ts;for(var i=0;i<schema.length;i++){var key=schema[i].key;if(e[key]!==undefined)obj[key]=e[key];}return obj;});var upd={};upd[k]=entries;api.updateFrontmatter(upd,p).then(function(){new Notice('YAML synced!');});}else if(state.settings.storageMode==='csv'){var d=state.settings.csvDelimiter;var schema=state.settings.schema||defaultSchema;var cols=schema.map(function(s){return s.key;});var header=cols.map(function(c){return'\"'+c+'\"';}).join(d)+'\\n';var rows=state.entries.slice().reverse().map(function(e){return cols.map(function(c){return'\"'+(e[c]||'').toString().replace(/\"/g,'\"\"')+'\"';}).join(d);}).join('\\n');api.writeFile(state.settings.csvPath,header+rows).then(function(){new Notice('CSV synced!');});}}function refreshFromYAML(){var p=state.settings.yamlPath||undefined;api.getFrontmatter(p).then(function(fm){var k=state.settings.yamlKey||'logs';if(fm&&Array.isArray(fm[k])){if(fm[k].length>0){updateSchemaFromKeys(Object.keys(fm[k][0]));}state.entries=fm[k].map(function(x){var o={};o.id=Date.now()+Math.random();for(var key in x)o[key]=x[key];return o;}).reverse();render();updateFieldDatalistsFromEntries();}});}function refreshFromCSV(){if(!app)return;var path=state.settings.csvPath;var d=state.settings.csvDelimiter;var file=app.vault.getAbstractFileByPath(path);if(file){app.vault.read(file).then(function(content){var lines=content.split('\\n').filter(function(l){return l.trim();});if(lines.length<2)return;var headerStr=lines[0];var headers=headerStr.split(d).map(function(h){return h.replace(/^\"|\"$/g,'');});updateSchemaFromKeys(headers);state.entries=lines.slice(1).map(function(line){var parts=line.split(d).map(function(p){return p.replace(/^\"|\"$/g,'');});var ent={};ent.id=Date.now()+Math.random();for(var i=0;i<headers.length;i++)ent[headers[i]]=parts[i]||'';return ent;}).reverse();render();updateFieldDatalistsFromEntries();});}}function render(){var indicator=root.getElementById('storage-indicator');if(indicator)indicator.innerText=state.settings.storageMode.toUpperCase();var yamlPanel=root.getElementById('yaml-config-panel');if(yamlPanel)yamlPanel.style.display=state.settings.storageMode==='yaml'?'block':'none';var csvPanel=root.getElementById('csv-config-panel');if(csvPanel)csvPanel.style.display=state.settings.storageMode==='csv'?'block':'none';var yPath=root.getElementById('main-yaml-path');var yKey=root.getElementById('main-yaml-key');if(yPath&&document.activeElement!==yPath)yPath.value=state.settings.yamlPath||'';if(yKey&&document.activeElement!==yKey)yKey.value=state.settings.yamlKey||'logs';var modeEl=root.getElementById('setting-storage-mode');if(modeEl)modeEl.value=state.settings.storageMode;var csvCont=root.getElementById('csv-path-cont');if(csvCont)csvCont.style.display=state.settings.storageMode==='csv'?'block':'none';var csvPathEl=root.getElementById('main-csv-path');if(csvPathEl&&document.activeElement!==csvPathEl)csvPathEl.value=state.settings.csvPath||'';var ths=root.querySelectorAll('#table-header > span[data-sort]');for(var t=0;t<ths.length;t++){ths[t].classList.remove('active');var arrow=ths[t].querySelector('.sort-arrow');if(arrow)arrow.textContent='';if(ths[t].getAttribute('data-sort')===state.settings.sortBy){ths[t].classList.add('active');if(arrow)arrow.textContent=state.settings.sortDir==='asc'?'^':'v';}}var schema=state.settings.schema||defaultSchema;var filtered=state.entries.filter(function(e){if(!searchQuery)return true;var tsStr=e.ts||'';if(tsStr.toLowerCase().indexOf(searchQuery)!==-1)return true;for(var i=0;i<schema.length;i++){var val=e[schema[i].key];if(val&&val.toString().toLowerCase().indexOf(searchQuery)!==-1)return true;}return false;});var sorted=filtered.slice();var dir=state.settings.sortDir==='asc'?1:-1;var sortKey=state.settings.sortBy;sorted.sort(function(a,b){var av=a[sortKey]||'';var bv=b[sortKey]||'';if(sortKey==='ts')return dir*(new Date(av)-new Date(bv));if(typeof av==='number'&&typeof bv==='number')return dir*(av-bv);return dir*av.toString().localeCompare(bv.toString());});var container=root.getElementById('logger-entries');if(!container)return;var html='';var toShow=sorted.slice(0,state.settings.showLastN);for(var i=0;i<toShow.length;i++){var e=toShow[i];var dt=new Date(e.ts);var time=dt.getHours()+':'+(dt.getMinutes()<10?'0':'')+dt.getMinutes();html+='<div class=\"logger-entry\"><span>'+time+'</span>';for(var j=0;j<schema.length;j++){var f=schema[j];var val=e[f.key];var displayVal=val;if(f.type==='checkbox')displayVal=val?'Y':'';html+='<span class=\"editable-cell\" data-id=\"'+e.id+'\" data-key=\"'+f.key+'\" data-type=\"'+f.type+'\" data-raw=\"'+(val||'')+'\">'+formatCell(displayVal)+'</span>';}html+='<span class=\"entry-delete\" data-id=\"'+e.id+'\">X</span></div>';}container.innerHTML=html;var delBtns=container.querySelectorAll('.entry-delete');for(var k=0;k<delBtns.length;k++){(function(btn){btn.onclick=function(){var id=parseFloat(btn.getAttribute('data-id'));state.entries=state.entries.filter(function(x){return x.id!==id;});render();save().then(function(){updateFieldDatalistsFromEntries();syncToExternal();});};})(delBtns[k]);}var cells=container.querySelectorAll('.editable-cell');for(var l=0;l<cells.length;l++){(function(c){c.onclick=function(e){if(e.target.tagName==='SPAN'&&e.target.classList.contains('link-tag')){searchTag(e.target.getAttribute('data-tag'));return;}if(c.querySelector('input,select'))return;var id=parseFloat(c.getAttribute('data-id'));var key=c.getAttribute('data-key');var type=c.getAttribute('data-type');var field=schema.find(function(s){return s.key===key;});var opts=field?field.options:[];editCell(c,id,key,type,opts);};})(cells[l]);}}function exportToCSV(){var d=state.settings.csvDelimiter;var schema=state.settings.schema||defaultSchema;var cols=schema.map(function(s){return s.key;});var header=cols.map(function(c){return'\"'+c+'\"';}).join(d)+'\\n';var rows=state.entries.map(function(e){return cols.map(function(c){return'\"'+(e[c]||'').toString().replace(/\"/g,'\"\"')+'\"';}).join(d);}).join('\\n');var blob=new Blob([header+rows],{type:'text/csv'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='export_'+Date.now()+'.csv';a.click();}function save(){var d={};if(state.settings.storageMode==='instance'){d.entries=state.entries;instanceBuffer=JSON.parse(JSON.stringify(state.entries));}else{d.entries=[];d.instanceEntries=instanceBuffer;}d.settings=state.settings;return api.saveState(d);}})();",
    "tags": [
        "productivity",
        "logging",
        "data",
        "custom",
        "schema",
        "yaml",
        "csv"
    ]
}